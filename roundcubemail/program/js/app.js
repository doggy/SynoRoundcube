function rcube_webmail(){this.labels={};this.buttons={};this.buttons_sel={};this.gui_objects={};this.gui_containers={};this.commands={};this.command_handlers={};this.onloads=[];this.messages={};this.group2expand={};this.dblclick_time=500;this.message_time=4E3;this.identifier_expr=RegExp("[^0-9a-z-_]","gi");this.env={request_timeout:180,draft_autosave:0,comm_path:"./",blankpage:"program/resources/blank.gif",recipients_separator:",",recipients_delimiter:", "};this.ref="rcmail";var l=this;$.ajaxSetup({cache:false,
timeout:this.env.request_timeout*1E3,error:function(a,b,d){l.http_error(a,b,d)},beforeSend:function(a){a.setRequestHeader("X-Roundcube-Request",l.env.request_token)}});$(window).bind("beforeunload",function(){rcmail.unload=true});this.set_env=function(a,b){if(a!=null&&typeof a==="object"&&!b)for(var d in a)this.env[d]=a[d];else this.env[a]=b};this.add_label=function(a,b){if(typeof a=="string")this.labels[a]=b;else typeof a=="object"&&$.extend(this.labels,a)};this.register_button=function(a,b,d,e,
g,f){b={id:b,type:d};if(e)b.act=e;if(g)b.sel=g;if(f)b.over=f;this.buttons[a]||(this.buttons[a]=[]);this.buttons[a].push(b);this.loaded&&u(a,b)};this.gui_object=function(a,b){this.gui_objects[a]=this.loaded?rcube_find_object(b):b};this.gui_container=function(a,b){this.gui_containers[a]=b};this.add_element=function(a,b){this.gui_containers[b]&&this.gui_containers[b].jquery&&this.gui_containers[b].append(a)};this.register_command=function(a,b,d){this.command_handlers[a]=b;d&&this.enable_command(a,true)};
this.add_onload=function(a){this.onloads.push(a)};this.init=function(){var a,b=this;this.task=this.env.task;if(!bw.dom||!bw.xmlhttp_test()||bw.mz&&bw.vendver<1.9)this.goto_url("error","_code=0x199");else{for(a in this.gui_containers)this.gui_containers[a]=$("#"+this.gui_containers[a]);for(a in this.gui_objects)this.gui_objects[a]=rcube_find_object(this.gui_objects[a]);if(this.env.x_frame_options)try{if(this.env.x_frame_options=="deny"&&top.location.href!=self.location.href)top.location.href=self.location.href;
else if(top.location.hostname!=self.location.hostname)throw 1;}catch(d){$("form").each(function(){l.lock_form(this,true)});this.display_message("Blocked: possible clickjacking attack!","error");return}this.init_buttons();if(this.is_framed()){parent.rcmail.set_busy(false,null,parent.rcmail.env.frame_lock);parent.rcmail.env.frame_lock=null}this.enable_command("close","logout","mail","addressbook","settings","save-pref","compose","undo","about","switch-task",true);this.env.permaurl&&this.enable_command("permaurl",
"extwin",true);switch(this.task){case "mail":this.enable_command("list","checkmail","add-contact","search","reset-search","collapse-folder",true);if(this.gui_objects.messagelist){this.message_list=new rcube_list_widget(this.gui_objects.messagelist,{multiselect:true,multiexpand:true,draggable:true,keyboard:true,column_movable:this.env.col_movable,dblclick_time:this.dblclick_time});this.message_list.row_init=function(f){b.init_message_row(f)};this.message_list.addEventListener("dblclick",function(f){b.msglist_dbl_click(f)});
this.message_list.addEventListener("click",function(f){b.msglist_click(f)});this.message_list.addEventListener("keypress",function(f){b.msglist_keypress(f)});this.message_list.addEventListener("select",function(f){b.msglist_select(f)});this.message_list.addEventListener("dragstart",function(f){b.drag_start(f)});this.message_list.addEventListener("dragmove",function(f){b.drag_move(f)});this.message_list.addEventListener("dragend",function(f){b.drag_end(f)});this.message_list.addEventListener("expandcollapse",
function(f){b.msglist_expand(f)});this.message_list.addEventListener("column_replace",function(f){b.msglist_set_coltypes(f)});document.onmouseup=function(f){return b.doc_mouse_up(f)};this.gui_objects.messagelist.parentNode.onmousedown=function(f){return b.click_on_list(f)};this.message_list.init();this.enable_command("toggle_status","toggle_flag","menu-open","menu-save","sort",true);this.command("list")}if(this.gui_objects.qsearchbox){if(this.env.search_text!=null)this.gui_objects.qsearchbox.value=
this.env.search_text;$(this.gui_objects.qsearchbox).focusin(function(){rcmail.message_list&&rcmail.message_list.blur()})}this.set_button_titles();this.env.message_commands=["show","reply","reply-all","reply-list","moveto","copy","delete","open","mark","edit","viewsource","print","load-attachment","show-headers","hide-headers","download","forward","forward-inline","forward-attachment"];if(this.env.action=="show"||this.env.action=="preview"){this.enable_command(this.env.message_commands,this.env.uid);
this.enable_command("reply-list",this.env.list_post);this.env.action=="show"&&this.http_request("pagenav",{_uid:this.env.uid,_mbox:this.env.mailbox,_search:this.env.search_request},this.display_message("","loading"));if(this.env.blockedobjects){if(this.gui_objects.remoteobjectsmsg)this.gui_objects.remoteobjectsmsg.style.display="block";this.enable_command("load-images","always-load",true)}if(this.env.action=="preview"&&this.is_framed()){this.enable_command("compose","add-contact",false);parent.rcmail.show_contentframe(true)}}else if(this.env.action==
"compose"){this.env.compose_commands=["send-attachment","remove-attachment","send","cancel","toggle-editor","list-adresses","search","reset-search","extwin"];this.env.drafts_mailbox&&this.env.compose_commands.push("savedraft");this.enable_command(this.env.compose_commands,"identities",true);$.merge(this.env.compose_commands,["add-recipient","firstpage","previouspage","nextpage","lastpage"]);if(this.env.spellcheck){this.env.spellcheck.spelling_state_observer=function(){l.spellcheck_state()};this.env.compose_commands.push("spellcheck");
this.enable_command("spellcheck",true)}document.onmouseup=function(f){return b.doc_mouse_up(f)};this.init_messageform()}else if(this.env.action=="print"&&this.env.uid)bw.safari?setTimeout("window.print()",10):window.print();if(this.gui_objects.mailboxlist){this.env.unread_counts={};this.gui_objects.folderlist=this.gui_objects.mailboxlist;this.http_request("getunread")}if(this.gui_objects.contactslist){this.contact_list=new rcube_list_widget(this.gui_objects.contactslist,{multiselect:true,draggable:false,
keyboard:false});this.contact_list.addEventListener("select",function(f){l.compose_recipient_select(f)});this.contact_list.addEventListener("dblclick",function(){l.compose_add_recipient("to")});this.contact_list.init()}if(this.gui_objects.addressbookslist){this.gui_objects.folderlist=this.gui_objects.addressbookslist;this.enable_command("list-adresses",true)}if(this.env.mdn_request&&this.env.uid){a="sendmdn";var e={_uid:this.env.uid,_mbox:this.env.mailbox};if(!confirm(this.get_label("mdnrequest"))){e._flag=
"mdnsent";a="mark"}this.http_post(a,e)}!this.is_framed()&&!this.env.extwin&&this.browser_capabilities_check();break;case "addressbook":if(this.gui_objects.folderlist)this.env.contactfolders=$.extend($.extend({},this.env.address_sources),this.env.contactgroups);this.enable_command("add","import",this.env.writable_source);this.enable_command("list","listgroup","listsearch","advanced-search",true);if(this.gui_objects.contactslist){this.contact_list=new rcube_list_widget(this.gui_objects.contactslist,
{multiselect:true,draggable:this.gui_objects.folderlist?true:false,keyboard:true});this.contact_list.row_init=function(f){b.triggerEvent("insertrow",{cid:f.uid,row:f})};this.contact_list.addEventListener("keypress",function(f){b.contactlist_keypress(f)});this.contact_list.addEventListener("select",function(f){b.contactlist_select(f)});this.contact_list.addEventListener("dragstart",function(f){b.drag_start(f)});this.contact_list.addEventListener("dragmove",function(f){b.drag_move(f)});this.contact_list.addEventListener("dragend",
function(f){b.drag_end(f)});this.contact_list.init();this.env.cid&&this.contact_list.highlight_row(this.env.cid);this.gui_objects.contactslist.parentNode.onmousedown=function(f){return b.click_on_list(f)};document.onmouseup=function(f){return b.doc_mouse_up(f)};this.gui_objects.qsearchbox&&$(this.gui_objects.qsearchbox).focusin(function(){rcmail.contact_list.blur()});this.update_group_commands();this.command("list")}this.set_page_buttons();if(this.env.cid){this.enable_command("show","edit",true);
this.gui_objects.editform&&$("input.groupmember").change(function(){l.group_member_change(this.checked?"add":"del",l.env.cid,l.env.source,this.value)})}if(this.gui_objects.editform){this.enable_command("save",true);if(this.env.action=="add"||this.env.action=="edit"||this.env.action=="search")this.init_contact_form()}this.gui_objects.qsearchbox&&this.enable_command("search","reset-search","moveto",true);break;case "settings":this.enable_command("preferences","identities","save","folders",true);if(this.env.action==
"identities")this.enable_command("add",this.env.identities_level<2);else if(this.env.action=="edit-identity"||this.env.action=="add-identity"){this.enable_command("save","edit","toggle-editor",true);this.enable_command("delete",this.env.identities_level<2);this.env.action=="add-identity"&&$("input[type='text']").first().select()}else if(this.env.action=="folders")this.enable_command("subscribe","unsubscribe","create-folder","rename-folder",true);else if(this.env.action=="edit-folder"&&this.gui_objects.editform){this.enable_command("save",
"folder-size",true);parent.rcmail.env.exists=this.env.messagecount;parent.rcmail.enable_command("purge",this.env.messagecount);$("input[type='text']").first().select()}if(this.gui_objects.identitieslist){this.identity_list=new rcube_list_widget(this.gui_objects.identitieslist,{multiselect:false,draggable:false,keyboard:false});this.identity_list.addEventListener("select",function(f){b.identity_select(f)});this.identity_list.init();this.identity_list.focus();this.env.iid&&this.identity_list.highlight_row(this.env.iid)}else if(this.gui_objects.sectionslist){this.sections_list=
new rcube_list_widget(this.gui_objects.sectionslist,{multiselect:false,draggable:false,keyboard:false});this.sections_list.addEventListener("select",function(f){b.section_select(f)});this.sections_list.init();this.sections_list.focus()}else this.gui_objects.subscriptionlist&&this.init_subscription_list();break;case "login":a=$("#rcmloginuser");a.bind("keyup",function(f){return rcmail.login_user_keyup(f)});a.val()==""?a.focus():$("#rcmloginpwd").focus();if(window.jstz&&!bw.ie6){a=jstz.determine();
a.name()&&$("#rcmlogintz").val(a.name())}else $("#rcmlogintz").val((new Date).getStdTimezoneOffset()/-60);$("form").submit(function(){$("input[type=submit]",this).prop("disabled",true);rcmail.clear_messages();rcmail.display_message("","loading")});this.enable_command("login",true)}if(this.env.contentframe&&!$("#"+this.env.contentframe).is(":visible"))this.env.contentframe=null;bw.ie&&$("input[type=file]").keydown(function(f){f.keyCode=="13"&&f.preventDefault()});this.loaded=true;this.pending_message&&
this.display_message(this.pending_message[0],this.pending_message[1],this.pending_message[2]);if(this.gui_objects.folderlist)this.gui_containers.foldertray=$(this.gui_objects.folderlist);if(this.gui_objects.filedrop&&this.env.filedrop&&(window.XMLHttpRequest&&XMLHttpRequest.prototype&&XMLHttpRequest.prototype.sendAsBinary||window.FormData)){$(document.body).bind("dragover dragleave drop",function(f){return l.document_drag_hover(f,f.type=="dragover")});$(this.gui_objects.filedrop).addClass("droptarget").bind("dragover dragleave",
function(f){return l.file_drag_hover(f,f.type=="dragover")}).get(0).addEventListener("drop",function(f){return l.file_dropped(f)},false)}this.triggerEvent("init",{task:this.task,action:this.env.action});for(var g in this.onloads)if(typeof this.onloads[g]==="string")eval(this.onloads[g]);else typeof this.onloads[g]==="function"&&this.onloads[g]();this.start_refresh();this.start_keepalive()}};this.log=function(a){window.console&&console.log&&console.log(a)};this.command=function(a,b,d,e){var g,f,h,
j;d&&d.blur&&d.blur();if(this.busy)return false;if(d&&d.href&&String(d.href).indexOf("#")<0&&rcube_event.get_modifier(e))return true;if(!this.commands[a]){this.is_framed()&&parent.rcmail.command(a,b);return false}if(this.task=="mail"&&this.env.action=="compose"&&$.inArray(a,this.env.compose_commands)<0)if(this.cmp_hash!=this.compose_field_hash()&&!confirm(this.get_label("notsentwarning")))return false;if(typeof this.command_handlers[a]==="function"){g=this.command_handlers[a](b,d);return g!==undefined?
g:d?false:true}else if(typeof this.command_handlers[a]==="string"){g=window[this.command_handlers[a]](b,d);return g!==undefined?g:d?false:true}this.triggerEvent("actionbefore",{props:b,action:a});g=this.triggerEvent("before"+a,b);if(g!==undefined)if(g===false)return false;else b=g;g=undefined;switch(a){case "login":this.gui_objects.loginform&&this.gui_objects.loginform.submit();break;case "mail":case "addressbook":case "settings":case "logout":this.switch_task(a);break;case "about":this.redirect("?_task=settings&_action=about",
false);break;case "permaurl":if(d&&d.href&&d.target)return true;else if(this.env.permaurl)parent.location.href=this.env.permaurl;break;case "extwin":if(this.env.action=="compose"){$("input[name='_action']",this.gui_objects.messageform).val("compose");this.gui_objects.messageform.action=this.url("mail/compose",{_id:this.env.compose_id,_extwin:1});this.gui_objects.messageform.target=this.open_window("",1100);this.gui_objects.messageform.submit()}else this.open_window(this.env.permaurl,900);break;case "menu-open":case "menu-save":this.triggerEvent(a,
{props:b});return false;case "open":if(f=this.get_single_uid()){d.href=this.url("show",{_mbox:this.env.mailbox,_uid:f});return true}break;case "close":this.env.extwin&&window.close();break;case "list":b&&b!=""&&this.reset_qsearch();if(this.env.action=="compose"&&this.env.extwin)window.close();else if(this.task=="mail"){this.list_mailbox(b);this.set_button_titles()}else this.task=="addressbook"&&this.list_contacts(b);break;case "sort":j=this.env.sort_order;f=!this.env.disabled_sort_col?b:this.env.sort_col;
this.env.disabled_sort_order||(j=this.env.sort_col==f&&j=="ASC"?"DESC":"ASC");this.set_list_sorting(f,j);this.list_mailbox("","",f+"_"+j);break;case "nextpage":this.list_page("next");break;case "lastpage":this.list_page("last");break;case "previouspage":this.list_page("prev");break;case "firstpage":this.list_page("first");break;case "expunge":this.env.exists&&this.expunge_mailbox(this.env.mailbox);break;case "purge":case "empty-mailbox":this.env.exists&&this.purge_mailbox(this.env.mailbox);break;
case "show":if(this.task=="mail"){if((f=this.get_single_uid())&&(!this.env.uid||f!=this.env.uid))this.env.mailbox==this.env.drafts_mailbox?this.open_compose_step({_draft_uid:f,_mbox:this.env.mailbox}):this.show_message(f)}else if(this.task=="addressbook")(h=b?b:this.get_single_cid())&&!(this.env.action=="show"&&h==this.env.cid)&&this.load_contact(h,"show");break;case "add":if(this.task=="addressbook")this.load_contact(0,"add");else if(this.task=="settings"){this.identity_list.clear_selection();this.load_identity(0,
"add-identity")}break;case "edit":if(this.task=="addressbook"&&(h=this.get_single_cid()))this.load_contact(h,"edit");else if(this.task=="settings"&&b)this.load_identity(b,"edit-identity");else if(this.task=="mail"&&(h=this.get_single_uid())){j={_mbox:this.env.mailbox};j[this.env.mailbox==this.env.drafts_mailbox&&b!="new"?"_draft_uid":"_uid"]=h;this.open_compose_step(j)}break;case "save":var m;if(j=this.gui_objects.editform){if(this.env.action!="search")if((m=$("input[name='_pagesize']",j))&&m.length&&
isNaN(parseInt(m.val()))){alert(this.get_label("nopagesizewarning"));m.focus();break}else{if(b=="reload")j.action+="?_reload=1";else if(this.task=="settings"&&this.env.identities_level%2==0&&(m=$("input[name='_email']",j))&&m.length&&!rcube_check_email(m.val())){alert(this.get_label("noemailwarning"));m.focus();break}$("input.placeholder").each(function(){if(this.value==this._placeholder)this.value=""})}if(parent.rcmail&&parent.rcmail.env.source)j.action=this.add_url(j.action,"_orig_source",parent.rcmail.env.source);
j.submit()}break;case "delete":if(this.task=="mail")this.delete_messages(e);else if(this.task=="addressbook")this.delete_contacts();else this.task=="settings"&&this.delete_identity();break;case "move":case "moveto":if(this.task=="mail")this.move_messages(b);else this.task=="addressbook"&&this.drag_active&&this.copy_contact(null,b);break;case "copy":this.task=="mail"&&this.copy_messages(b);break;case "mark":b&&this.mark_message(b);break;case "toggle_status":if(b&&!b._row)break;j="read";if(b._row.uid){f=
b._row.uid;if(this.message_list.rows[f].deleted)j="undelete";else this.message_list.rows[f].unread||(j="unread")}this.mark_message(j,f);break;case "toggle_flag":if(b&&!b._row)break;j="flagged";if(b._row.uid){f=b._row.uid;if(this.message_list.rows[f].flagged)j="unflagged"}this.mark_message(j,f);break;case "always-load":if(this.env.uid&&this.env.sender){this.add_contact(this.env.sender);setTimeout(function(){l.command("load-images")},300);break}case "load-images":this.env.uid&&this.show_message(this.env.uid,
true,this.env.action=="preview");break;case "load-attachment":j="_mbox="+urlencode(this.env.mailbox)+"&_uid="+this.env.uid+"&_part="+b.part;if(this.env.uid&&b.mimetype&&this.env.mimetypes&&$.inArray(b.mimetype,this.env.mimetypes)>=0){var k=window.open(this.env.comm_path+"&_action=get&"+j+"&_frame=1",this.html_identifier("rcubemailattachment"+this.env.uid+b.part));if(k){setTimeout(function(){k.focus()},10);break}}this.goto_url("get",j+"&_download=1",false);break;case "select-all":this.select_all_mode=
b?false:true;this.dummy_select=true;b=="invert"?this.message_list.invert_selection():this.message_list.select_all(b=="page"?"":b);this.dummy_select=null;break;case "select-none":this.select_all_mode=false;this.message_list.clear_selection();break;case "expand-all":this.env.autoexpand_threads=1;this.message_list.expand_all();break;case "expand-unread":this.env.autoexpand_threads=2;this.message_list.collapse_all();this.expand_unread();break;case "collapse-all":this.env.autoexpand_threads=0;this.message_list.collapse_all();
break;case "nextmessage":this.env.next_uid&&this.show_message(this.env.next_uid,false,this.env.action=="preview");break;case "lastmessage":this.env.last_uid&&this.show_message(this.env.last_uid);break;case "previousmessage":this.env.prev_uid&&this.show_message(this.env.prev_uid,false,this.env.action=="preview");break;case "firstmessage":this.env.first_uid&&this.show_message(this.env.first_uid);break;case "compose":j={};if(this.task=="mail"){j._mbox=this.env.mailbox;if(b)j._to=b;if(this.env.search_request)j._search=
this.env.search_request}else if(this.task=="addressbook")if(b&&b.indexOf("@")>0)j._to=b;else{h=[];if(b)h.push(b);else if(this.contact_list){m=this.contact_list.get_selection();j=0;for(f=m.length;j<f;j++)h.push(m[j])}if(h.length)this.http_post("mailto",{_cid:h.join(","),_source:this.env.source},true);else this.env.group&&this.http_post("mailto",{_gid:this.env.group,_source:this.env.source},true);break}else if(b)j._to=b;this.open_compose_step(j);break;case "spellcheck":if(this.spellcheck_state())this.stop_spellchecking();
else if(window.tinyMCE&&tinyMCE.get(this.env.composebody))tinyMCE.execCommand("mceSpellCheck",true);else this.env.spellcheck&&this.env.spellcheck.spellCheck&&this.env.spellcheck.spellCheck();this.spellcheck_state();break;case "savedraft":clearTimeout(this.save_timer);if(this.env.draft_id&&this.cmp_hash==this.compose_field_hash()){this.auto_save_start();break}this.submit_messageform(true);break;case "send":if(!b.nocheck&&!this.check_compose_input(a))break;clearTimeout(this.save_timer);this.submit_messageform();
break;case "send-attachment":clearTimeout(this.save_timer);this.upload_file(b||this.gui_objects.uploadform);break;case "insert-sig":this.change_identity($("[name='_from']")[0],true);break;case "list-adresses":this.list_contacts(b);this.enable_command("add-recipient",false);break;case "add-recipient":this.compose_add_recipient(b);break;case "reply-all":case "reply-list":case "reply":if(f=this.get_single_uid()){j={_reply_uid:f,_mbox:this.env.mailbox};if(a=="reply-all")j._all=!b&&this.commands["reply-list"]?
"list":"all";else if(a=="reply-list")j._all="list";this.open_compose_step(j)}break;case "forward-attachment":case "forward-inline":case "forward":f=this.env.uid?[this.env.uid]:this.message_list?this.message_list.get_selection():[];if(f.length){j={_forward_uid:this.uids_to_list(f),_mbox:this.env.mailbox};if(a=="forward-attachment"||!b&&this.env.forward_attachment||f.length>1)j._attachment=1;this.open_compose_step(j)}break;case "print":if(f=this.get_single_uid()){l.printwin=window.open(this.env.comm_path+
"&_action=print&_uid="+f+"&_mbox="+urlencode(this.env.mailbox)+(this.env.safemode?"&_safe=1":""));if(this.printwin){setTimeout(function(){l.printwin.focus()},20);this.env.action!="show"&&this.mark_message("read",f)}}break;case "viewsource":if(f=this.get_single_uid()){l.sourcewin=window.open(this.env.comm_path+"&_action=viewsource&_uid="+f+"&_mbox="+urlencode(this.env.mailbox));this.sourcewin&&setTimeout(function(){l.sourcewin.focus()},20)}break;case "download":if(f=this.get_single_uid())this.goto_url("viewsource",
{_uid:f,_mbox:this.env.mailbox,_save:1});break;case "search":if(!b&&this.gui_objects.qsearchbox)b=this.gui_objects.qsearchbox.value;if(b){this.qsearch(b);break}case "reset-search":f=this.env.search_request||this.env.qsearch;this.reset_qsearch();this.select_all_mode=false;if(f&&this.env.action=="compose")this.contact_list&&this.list_contacts_clear();else if(f&&this.env.mailbox)this.list_mailbox(this.env.mailbox,1);else if(f&&this.task=="addressbook"){if(this.env.source==""){for(j in this.env.address_sources)break;
this.env.source=j;this.env.group=""}this.list_contacts(this.env.source,this.env.group,1)}break;case "listgroup":this.reset_qsearch();this.list_contacts(b.source,b.id);break;case "import":if(this.env.action=="import"&&this.gui_objects.importform){if((j=document.getElementById("rcmimportfile"))&&!j.value){alert(this.get_label("selectimportfile"));break}this.gui_objects.importform.submit();this.set_busy(true,"importwait");this.lock_form(this.gui_objects.importform,true)}else this.goto_url("import",this.env.source?
"_target="+urlencode(this.env.source)+"&":"");break;case "export":this.contact_list.rowcount>0&&this.goto_url("export",{_source:this.env.source,_gid:this.env.group,_search:this.env.search_request});break;case "upload-photo":this.upload_contact_photo(b||this.gui_objects.uploadform);break;case "delete-photo":this.replace_contact_photo("-del-");break;case "preferences":case "identities":case "folders":this.goto_url("settings/"+a);break;case "undo":this.http_request("undo","",this.display_message("",
"loading"));break;default:j=a.replace(/-/g,"_");if(this[j]&&typeof this[j]==="function")g=this[j](b,d)}if(this.triggerEvent("after"+a,b)===false)g=false;this.triggerEvent("actionafter",{props:b,action:a});return g===false?false:d?false:true};this.enable_command=function(){var a,b,d=Array.prototype.slice.call(arguments),e=d.pop(),g;for(b=0;b<d.length;b++){g=d[b];if(typeof g==="string"){this.commands[g]=e;this.set_button(g,e?"act":"pas")}else for(a in g)d.push(g[a])}};this.set_busy=function(a,b,d){if(a&&
b){d=this.get_label(b);if(d==b)d="Loading...";d=this.display_message(d,"loading")}else!a&&d&&this.hide_message(d);this.busy=a;this.gui_objects.editform&&this.lock_form(this.gui_objects.editform,a);return d};this.gettext=this.get_label=function(a,b){return b&&this.labels[b+"."+a]?this.labels[b+"."+a]:this.labels[a]?this.labels[a]:a};this.switch_task=function(a){if(!(this.task===a&&a!="mail")){var b=this.get_task_url(a);if(a=="mail")b+="&_mbox=INBOX";this.redirect(b)}};this.get_task_url=function(a,
b){if(!b)b=this.env.comm_path;return b.replace(/_task=[a-z]+/,"_task="+a)};this.reload=function(a){if(this.is_framed())parent.rcmail.reload(a);else if(a)setTimeout(function(){rcmail.reload()},a);else if(window.location)location.href=this.env.comm_path+(this.env.action?"&_action="+this.env.action:"")};this.add_url=function(a,b,d){d=urlencode(d);if(/(\?.*)$/.test(a)){var e=RegExp.$1,g=RegExp("((\\?|&)"+RegExp.escape(b)+"=[^&]*)");if(g.test(e))e=e.replace(g,RegExp.$2+b+"="+d);else e+="&"+b+"="+d;return a.replace(/(\?.*)$/,
e)}return a+"?"+b+"="+d};this.is_framed=function(){return this.env.framed&&parent.rcmail&&parent.rcmail!=this&&parent.rcmail.command};this.save_pref=function(a){var b={_name:a.name,_value:a.value};if(a.session)b._session=a.session;if(a.env)this.env[a.env]=a.value;this.http_post("save-pref",b)};this.html_identifier=function(a,b){a=String(a);return b?Base64.encode(a).replace(/=+$/,"").replace(/\+/g,"-").replace(/\//g,"_"):a.replace(this.identifier_expr,"_")};this.html_identifier_decode=function(a){for(a=
String(a).replace(/-/g,"+").replace(/_/g,"/");a.length%4;)a+="=";return Base64.decode(a)};this.drag_menu=function(a,b){var d=rcube_event.get_modifier(a),e=this.gui_objects.message_dragmenu;if(e&&d==SHIFT_KEY&&this.commands.copy){d=rcube_event.get_mouse_pos(a);this.env.drag_target=b;$(e).css({top:d.y-10+"px",left:d.x-10+"px"}).show();return true}return false};this.drag_menu_action=function(a){var b=this.gui_objects.message_dragmenu;b&&$(b).hide();this.command(a,this.env.drag_target);this.env.drag_target=
null};this.drag_start=function(a){var b=this.task=="mail"?this.env.mailboxes:this.env.contactfolders;this.drag_active=true;this.preview_timer&&clearTimeout(this.preview_timer);this.preview_read_timer&&clearTimeout(this.preview_read_timer);if(this.gui_objects.folderlist&&b){this.initialBodyScrollTop=bw.ie?0:window.pageYOffset;this.initialListScrollTop=this.gui_objects.folderlist.parentNode.scrollTop;var d,e;a=$(this.gui_objects.folderlist);pos=a.offset();this.env.folderlist_coords={x1:pos.left,y1:pos.top,
x2:pos.left+a.width(),y2:pos.top+a.height()};this.env.folder_coords=[];for(d in b)if(a=this.get_folder_li(d))if(e=a.firstChild.offsetHeight){pos=$(a.firstChild).offset();this.env.folder_coords[d]={x1:pos.left,y1:pos.top,x2:pos.left+a.firstChild.offsetWidth,y2:pos.top+e,on:0}}}};this.drag_end=function(){this.drag_active=false;this.env.last_folder_target=null;if(this.folder_auto_timer){clearTimeout(this.folder_auto_timer);this.folder_auto_expand=this.folder_auto_timer=null}if(this.gui_objects.folderlist&&
this.env.folder_coords)for(var a in this.env.folder_coords)this.env.folder_coords[a].on&&$(this.get_folder_li(a)).removeClass("droptarget")};this.drag_move=function(a){if(this.gui_objects.folderlist&&this.env.folder_coords){var b,d,e,g,f;d="draglayernormal";a=rcube_event.get_mouse_pos(a);g=this.env.folderlist_coords;e=bw.ie?-document.documentElement.scrollTop:this.initialBodyScrollTop;var h=this.initialListScrollTop-this.gui_objects.folderlist.parentNode.scrollTop;if(this.contact_list&&this.contact_list.draglayer)f=
this.contact_list.draglayer.attr("class");a.y+=-h-e;if(a.x<g.x1||a.x>=g.x2||a.y<g.y1||a.y>=g.y2){if(this.env.last_folder_target){$(this.get_folder_li(this.env.last_folder_target)).removeClass("droptarget");this.env.folder_coords[this.env.last_folder_target].on=0;this.env.last_folder_target=null}}else for(b in this.env.folder_coords){g=this.env.folder_coords[b];if(a.x>=g.x1&&a.x<g.x2&&a.y>=g.y1&&a.y<g.y2)if(g=this.check_droptarget(b)){d=this.get_folder_li(b);e=$(d.getElementsByTagName("div")[0]);if(e.hasClass("collapsed")){this.folder_auto_timer&&
clearTimeout(this.folder_auto_timer);this.folder_auto_expand=this.env.mailboxes[b].id;this.folder_auto_timer=setTimeout(function(){rcmail.command("collapse-folder",rcmail.folder_auto_expand);rcmail.drag_start(null)},1E3)}else if(this.folder_auto_timer){clearTimeout(this.folder_auto_timer);this.folder_auto_expand=this.folder_auto_timer=null}$(d).addClass("droptarget");this.env.folder_coords[b].on=1;this.env.last_folder_target=b;d="draglayer"+(g>1?"copy":"normal")}else this.env.last_folder_target=null;
else if(g.on){$(this.get_folder_li(b)).removeClass("droptarget");this.env.folder_coords[b].on=0}}d!=f&&this.contact_list&&this.contact_list.draglayer&&this.contact_list.draglayer.attr("class",d)}};this.collapse_folder=function(a){var b=this.get_folder_li(a,"",true),d=$("div:first",b),e=$("ul:first",b);if(d.hasClass("collapsed")){e.show();d.removeClass("collapsed").addClass("expanded");this.env.collapsed_folders=this.env.collapsed_folders.replace(RegExp("&"+urlencode(a)+"&"),"")}else if(d.hasClass("expanded")){e.hide();
d.removeClass("expanded").addClass("collapsed");this.env.collapsed_folders=this.env.collapsed_folders+"&"+urlencode(a)+"&";this.env.mailbox.indexOf(a+this.env.delimiter)==0&&!$(b).hasClass("virtual")&&this.command("list",a)}else return;if(bw.ie6||bw.ie7)if((d=b.nextSibling?b.nextSibling.getElementsByTagName("ul"):null)&&d.length&&(b=d[0])&&b.style&&b.style.display!="none"){b.style.display="none";b.style.display=""}this.command("save-pref",{name:"collapsed_folders",value:this.env.collapsed_folders});
this.set_unread_count_display(a,false)};this.doc_mouse_up=function(a){var b,d,e;if(!$(rcube_event.get_target(a)).closest(".ui-dialog, .ui-widget-overlay").length){if(d=this.message_list)b=this.env.mailboxes;else if(d=this.contact_list)b=this.env.contactfolders;else this.ksearch_value&&this.ksearch_blur();d&&!rcube_mouse_is_over(a,d.list.parentNode)&&d.blur();if(this.drag_active&&b&&this.env.last_folder_target){b=b[this.env.last_folder_target];$(this.get_folder_li(this.env.last_folder_target)).removeClass("droptarget");
this.env.last_folder_target=null;d.draglayer.hide();this.drag_menu(a,b)||this.command("moveto",b)}if(this.buttons_sel){for(e in this.buttons_sel)typeof e!=="function"&&this.button_out(this.buttons_sel[e],e);this.buttons_sel={}}}};this.click_on_list=function(){this.gui_objects.qsearchbox&&this.gui_objects.qsearchbox.blur();if(this.message_list)this.message_list.focus();else this.contact_list&&this.contact_list.focus();return true};this.msglist_select=function(a){this.preview_timer&&clearTimeout(this.preview_timer);
this.preview_read_timer&&clearTimeout(this.preview_read_timer);var b=a.get_single_selection();this.enable_command(this.env.message_commands,b!=null);if(b)if(this.env.mailbox==this.env.drafts_mailbox)this.enable_command("reply","reply-all","reply-list","forward","forward-attachment","forward-inline",false);else this.env.messages[b].ml||this.enable_command("reply-list",false);this.enable_command("delete","moveto","copy","mark","forward","forward-attachment",a.selection.length>0);if(b||a.selection.length&&
a.selection.length!=a.rowcount)this.select_all_mode=false;if(b&&this.env.contentframe&&!a.multi_selecting&&!this.dummy_select)this.preview_timer=setTimeout(function(){l.msglist_get_preview()},this.dblclick_time);else this.env.contentframe&&this.show_contentframe(false)};this.msglist_click=function(a){if(!(a.multi_selecting||!this.env.contentframe))if(!a.get_single_selection())if((a=this.get_frame_window(this.env.contentframe))&&a.location.href.indexOf(this.env.blankpage)>=0){this.preview_timer&&clearTimeout(this.preview_timer);
this.preview_read_timer&&clearTimeout(this.preview_read_timer);this.preview_timer=setTimeout(function(){l.msglist_get_preview()},this.dblclick_time)}};this.msglist_dbl_click=function(a){this.preview_timer&&clearTimeout(this.preview_timer);this.preview_read_timer&&clearTimeout(this.preview_read_timer);if((a=a.get_single_selection())&&this.env.mailbox==this.env.drafts_mailbox)this.open_compose_step({_draft_uid:a,_mbox:this.env.mailbox});else a&&this.show_message(a,false,false)};this.msglist_keypress=
function(a){if(a.modkey!=CONTROL_KEY)if(a.key_pressed==a.ENTER_KEY)this.command("show");else if(a.key_pressed==a.DELETE_KEY||a.key_pressed==a.BACKSPACE_KEY)this.command("delete");else if(a.key_pressed==33)this.command("previouspage");else a.key_pressed==34&&this.command("nextpage")};this.msglist_get_preview=function(){var a=this.get_single_uid();if(a&&this.env.contentframe&&!this.drag_active)this.show_message(a,false,true);else this.env.contentframe&&this.show_contentframe(false)};this.msglist_expand=
function(a){if(this.env.messages[a.uid])this.env.messages[a.uid].expanded=a.expanded;$(a.obj)[a.expanded?"addClass":"removeClass"]("expanded")};this.msglist_set_coltypes=function(a){var b,d=a.list.tHead.rows[0].cells;this.env.coltypes=[];for(a=0;a<d.length;a++)if(d[a].id&&d[a].id.match(/^rcm/)){b=d[a].id.replace(/^rcm/,"");this.env.coltypes.push(b)}if((a=$.inArray("flag",this.env.coltypes))>=0)this.env.flagged_col=a;if((a=$.inArray("subject",this.env.coltypes))>=0)this.env.subject_col=a;this.command("save-pref",
{name:"list_cols",value:this.env.coltypes,session:"list_attrib/columns"})};this.check_droptarget=function(a){if(this.task=="mail")return this.env.mailboxes[a]&&this.env.mailboxes[a].id!=this.env.mailbox&&!this.env.mailboxes[a].virtual?1:0;if(this.task=="settings")return a!=this.env.mailbox?1:0;if(this.task=="addressbook")if(a!=this.env.source&&this.env.contactfolders[a])if(this.env.contactfolders[a].type=="group"){var b=this.env.contactfolders[a].source;if(this.env.contactfolders[a].id!=this.env.group&&
!this.env.contactfolders[b].readonly)return this.env.selection_sources.length>1||$.inArray(b,this.env.selection_sources)==-1?2:1}else if(!this.env.contactfolders[a].readonly)return this.env.selection_sources.length>1||$.inArray(a,this.env.selection_sources)==-1?2:0;return 0};this.open_window=function(a,b){var d=this.is_framed()?parent.window:window,e=$(d),g=e.width();e=bw.mz?$("body",d).height():e.height();g=Math.min(b,g);var f=(d.screenLeft||d.screenX)+20;d=(d.screenTop||d.screenY)+20;var h="rcmextwin"+
(new Date).getTime(),j=window.open(a+(a.match(/\?/)?"&":"?")+"_extwin=1",h,"width="+g+",height="+e+",top="+d+",left="+f+",resizable=yes,toolbar=no,status=no,location=no");!a&&j.document&&j.document.write("<html><body>"+this.get_label("loading")+"</body></html>");window.setTimeout(function(){j.focus()},10);return h};this.init_message_row=function(a){var b,d=this,e=a.uid,g=(this.env.status_col!=null?"status":"msg")+"icn"+a.uid;e&&this.env.messages[e]&&$.extend(a,this.env.messages[e]);if(a.icon=document.getElementById(g)){a.icon._row=
a.obj;a.icon.onmousedown=function(f){d.command("toggle_status",this);rcube_event.cancel(f)}}a.msgicon=this.env.status_col!=null?document.getElementById("msgicn"+a.uid):a.icon;if(this.env.flagged_col!=null&&(a.flagicon=document.getElementById("flagicn"+a.uid))){a.flagicon._row=a.obj;a.flagicon.onmousedown=function(f){d.command("toggle_flag",this);rcube_event.cancel(f)}}if(!a.depth&&a.has_children&&(b=document.getElementById("rcmexpando"+a.uid))){a.expando=b;b.onmousedown=function(f){return d.expand_message_row(f,
e)};bw.touch&&b.addEventListener("touchend",function(f){if(f.changedTouches.length==1){d.expand_message_row(f,e);return rcube_event.cancel(f)}},false)}this.triggerEvent("insertrow",{uid:e,row:a})};this.add_message_row=function(a,b,d,e){if(!this.gui_objects.messagelist||!this.message_list)return false;if(d.mbox!=this.env.mailbox&&!d.skip_mbox_check)return false;this.env.messages[a]||(this.env.messages[a]={});$.extend(this.env.messages[a],{deleted:d.deleted?1:0,replied:d.answered?1:0,unread:!d.seen?
1:0,forwarded:d.forwarded?1:0,flagged:d.flagged?1:0,has_children:d.has_children?1:0,depth:d.depth?d.depth:0,unread_children:d.unread_children?d.unread_children:0,parent_uid:d.parent_uid?d.parent_uid:0,selected:this.select_all_mode||this.message_list.in_selection(a),ml:d.ml?1:0,ctype:d.ctype,flags:d.extra_flags});var g,f,h,j="",m="",k=this.message_list;h=k.rows;var n=this.env.messages[a],o="message"+(!d.seen?" unread":"")+(d.deleted?" deleted":"")+(d.flagged?" flagged":"")+(n.selected?" selected":
""),p=document.createElement("tr");p.id="rcmrow"+a;g="msgicon";if(this.env.status_col===null){g+=" status";if(d.deleted)g+=" deleted";else if(d.seen){if(d.unread_children>0)g+=" unreadchildren"}else g+=" unread"}if(d.answered)g+=" replied";if(d.forwarded)g+=" forwarded";n.selected&&!k.in_selection(a)&&k.selection.push(a);if(this.env.threading){if(n.depth){j+='<span id="rcmtab'+a+'" class="branch" style="width:'+n.depth*15+'px;">&nbsp;&nbsp;</span>';if(h[n.parent_uid]&&h[n.parent_uid].expanded===false||
(this.env.autoexpand_threads==0||this.env.autoexpand_threads==2)&&(!h[n.parent_uid]||!h[n.parent_uid].expanded)){p.style.display="none";n.expanded=false}else n.expanded=true;o+=" thread expanded"}else if(n.has_children){if(n.expanded===undefined&&(this.env.autoexpand_threads==1||this.env.autoexpand_threads==2&&n.unread_children))n.expanded=true;m='<div id="rcmexpando'+a+'" class="'+(n.expanded?"expanded":"collapsed")+'">&nbsp;&nbsp;</div>';o+=" thread"+(n.expanded?" expanded":"")}if(d.unread_children&&
d.seen&&!n.expanded)o+=" unroot"}j+='<span id="msgicn'+a+'" class="'+g+'">&nbsp;</span>';p.className=o;if(!bw.ie&&b.subject){h=d.mbox==this.env.drafts_mailbox?"_draft_uid":"_uid";b.subject='<a href="./?_task=mail&_action='+(d.mbox==this.env.drafts_mailbox?"compose":"show")+"&_mbox="+urlencode(d.mbox)+"&"+h+"="+a+'" onclick="return rcube_event.cancel(event)" onmouseover="rcube_webmail.long_subject_title(this,'+(n.depth+1)+')">'+b.subject+"</a>"}for(f in this.env.coltypes){g=this.env.coltypes[f];h=
document.createElement("td");h.className=String(g).toLowerCase();if(g=="flag"){g=d.flagged?"flagged":"unflagged";g='<span id="flagicn'+a+'" class="'+g+'">&nbsp;</span>'}else if(g=="attachment")g=/application\/|multipart\/(m|signed)/.test(d.ctype)?'<span class="attachment">&nbsp;</span>':/multipart\/report/.test(d.ctype)?'<span class="report">&nbsp;</span>':"&nbsp;";else if(g=="status"){g=d.deleted?"deleted":d.seen?d.unread_children>0?"unreadchildren":"msgicon":"unread";g='<span id="statusicn'+a+'" class="'+
g+'">&nbsp;</span>'}else if(g=="threads")g=m;else if(g=="subject"){if(bw.ie){h.onmouseover=function(){rcube_webmail.long_subject_title_ex(this,n.depth+1)};if(bw.ie8)j="<span></span>"+j}g=j+b[g]}else g=g=="priority"?d.prio>0&&d.prio<6?'<span class="prio'+d.prio+'">&nbsp;</span>':"&nbsp;":b[g];if(g)h.innerHTML=g;p.appendChild(h)}k.insert_row(p,e);if(e&&this.env.pagesize&&k.rowcount>this.env.pagesize){a=k.get_last_row();k.remove_row(a);k.clear_selection(a)}};this.set_list_sorting=function(a,b){$("#rcm"+
this.env.sort_col).removeClass("sorted"+this.env.sort_order.toUpperCase());a&&$("#rcm"+a).addClass("sorted"+b);this.env.sort_col=a;this.env.sort_order=b};this.set_list_options=function(a,b,d,e){var g,f={};if(b===undefined)b=this.env.sort_col;if(!d)d=this.env.sort_order;if(this.env.sort_col!=b||this.env.sort_order!=d){g=1;this.set_list_sorting(b,d)}if(this.env.threading!=e){g=1;f._threads=e}if(a&&a.length){var h,j,m=[],k=this.env.coltypes;for(e=0;e<k.length;e++){j=k[e];h=$.inArray(j,a);if(h!=-1){m.push(j);
delete a[h]}}for(e=0;e<a.length;e++)a[e]&&m.push(a[e]);if(m.join()!=k.join()){g=1;f._cols=m.join(",")}}g&&this.list_mailbox("","",b+"_"+d,f)};this.show_message=function(a,b,d){if(a){var e,g=window,f="&_action="+(d?"preview":"show")+"&_uid="+a+"&_mbox="+urlencode(this.env.mailbox);if(d&&(e=this.get_frame_window(this.env.contentframe))){g=e;f+="&_framed=1"}if(b)f+="&_safe=1";if(this.env.search_request)f+="&_search="+this.env.search_request;f+="&_caps="+urlencode(this.browser_capabilities());if(this.env.extwin)f+=
"&_extwin=1";if(d&&String(g.location.href).indexOf(f)>=0)this.show_contentframe(true);else{!d&&this.env.message_extwin&&!this.env.extwin?this.open_window(this.env.comm_path+f,1E3):this.location_href(this.env.comm_path+f,g,true);if(d&&this.message_list&&this.message_list.rows[a]&&this.message_list.rows[a].unread&&this.env.preview_pane_mark_read>=0)this.preview_read_timer=setTimeout(function(){l.set_message(a,"unread",false);l.update_thread_root(a,"read");if(l.env.unread_counts[l.env.mailbox]){l.env.unread_counts[l.env.mailbox]-=
1;l.set_unread_count(l.env.mailbox,l.env.unread_counts[l.env.mailbox],l.env.mailbox=="INBOX")}l.env.preview_pane_mark_read>0&&l.http_post("mark",{_uid:a,_flag:"read",_quiet:1})},this.env.preview_pane_mark_read*1E3)}}};this.show_contentframe=function(a){var b,d,e=this.env.contentframe;if(e&&(b=this.get_frame_element(e)))if(!a&&(d=this.get_frame_window(e))){if(d.location&&d.location.href.indexOf(this.env.blankpage)<0)d.location.href=this.env.blankpage}else if(!bw.safari&&!bw.konq)$(b)[a?"show":"hide"]();
!a&&this.busy&&this.set_busy(false,null,this.env.frame_lock)};this.get_frame_element=function(a){var b;if(a&&(b=document.getElementById(a)))return b};this.get_frame_window=function(a){if((a=this.get_frame_element(a))&&a.name&&window.frames)return window.frames[a.name]};this.lock_frame=function(){if(!this.env.frame_lock)(this.is_framed()?parent.rcmail:this).env.frame_lock=this.set_busy(true,"loading")};this.list_page=function(a){if(a=="next")a=this.env.current_page+1;else if(a=="last")a=this.env.pagecount;
else if(a=="prev"&&this.env.current_page>1)a=this.env.current_page-1;else if(a=="first"&&this.env.current_page>1)a=1;if(a>0&&a<=this.env.pagecount){this.env.current_page=a;if(this.task=="addressbook"||this.contact_list)this.list_contacts(this.env.source,this.env.group,a);else this.task=="mail"&&this.list_mailbox(this.env.mailbox,a)}};this.checkmail=function(){var a=this.set_busy(true,"checkingmail");this.http_request("check-recent",this.check_recent_params(),a)};this.filter_mailbox=function(a){var b=
this.set_busy(true,"searching");this.clear_message_list();this.env.current_page=1;this.http_request("search",this.search_params(false,a),b)};this.list_mailbox=function(a,b,d,e){var g=window;if(typeof e!="object")e={};a||(a=this.env.mailbox?this.env.mailbox:"INBOX");if(d)e._sort=d;if(this.env.search_request)e._search=this.env.search_request;if(this.env.mailbox!=a){b=1;this.env.current_page=b;this.select_all_mode=false}this.clear_message_list();if(a!=this.env.mailbox||a==this.env.mailbox&&!b&&!d)e._refresh=
1;this.select_folder(a,"",true);this.unmark_folder(a,"recent","",true);this.env.mailbox=a;if(this.gui_objects.messagelist)this.list_mailbox_remote(a,b,e);else{if(d=this.get_frame_window(this.env.contentframe)){g=d;e._framed=1}if(a){this.set_busy(true,"loading");e._mbox=a;if(b)e._page=b;this.location_href(e,g)}}};this.clear_message_list=function(){this.env.messages={};this.last_selected=0;this.show_contentframe(false);this.message_list&&this.message_list.clear(true)};this.list_mailbox_remote=function(a,
b,d){this.message_list.clear();var e=this.set_busy(true,"loading");if(typeof d!="object")d={};d._mbox=a;if(b)d._page=b;this.http_request("list",d,e)};this.update_selection=function(){var a=this.message_list.selection,b=this.message_list.rows,d,e=[];for(d in a)b[a[d]]&&e.push(a[d]);this.message_list.selection=e};this.expand_unread=function(){for(var a,b=this.gui_objects.messagelist.tBodies[0].firstChild;b;){if(b.nodeType==1&&(a=this.message_list.rows[b.uid])&&a.unread_children){this.message_list.expand_all(a);
this.set_unread_children(a.uid)}b=b.nextSibling}return false};this.expand_message_row=function(a,b){var d=this.message_list.rows[b];d.expanded=!d.expanded;this.set_unread_children(b);d.expanded=!d.expanded;this.message_list.expand_row(a,b)};this.expand_threads=function(){if(!(!this.env.threading||!this.env.autoexpand_threads||!this.message_list))switch(this.env.autoexpand_threads){case 2:this.expand_unread();break;case 1:this.message_list.expand_all()}};this.init_threads=function(a,b){if(b&&b!=this.env.mailbox)return false;
for(var d=0,e=a.length;d<e;d++)this.add_tree_icons(a[d]);this.expand_threads()};this.add_tree_icons=function(a){var b,d,e,g,f=[],h=[],j,m=this.message_list.rows;for(j=a?m[a]?m[a].obj:null:this.message_list.list.tBodies[0].firstChild;j;){if(j.nodeType==1&&(d=m[j.uid]))if(d.depth){for(b=f.length-1;b>=0;b--){e=f[b].length;if(e>d.depth){g=e-d.depth;f[b][g]&2||(f[b][g]=f[b][g]?f[b][g]+2:2)}else if(e==d.depth)f[b][0]&2||(f[b][0]+=2);if(d.depth>e)break}f.push(Array(d.depth));f[f.length-1][0]=1;h.push(d.uid)}else{if(f.length){for(b in f)this.set_tree_icons(h[b],
f[b]);f=[];h=[]}if(a&&j!=m[a].obj)break}j=j.nextSibling}if(f.length)for(b in f)this.set_tree_icons(h[b],f[b])};this.set_tree_icons=function(a,b){var d,e=[],g="",f=b.length;for(d=0;d<f;d++)if(b[d]>2)e.push({"class":"l3",width:15});else if(b[d]>1)e.push({"class":"l2",width:15});else if(b[d]>0)e.push({"class":"l1",width:15});else if(e.length&&!e[e.length-1]["class"])e[e.length-1].width+=15;else e.push({"class":null,width:15});for(d=e.length-1;d>=0;d--)g+=e[d]["class"]?'<div class="tree '+e[d]["class"]+
'" />':'<div style="width:'+e[d].width+'px" />';g&&$("#rcmtab"+a).html(g)};this.update_thread_root=function(a,b){if(this.env.threading){var d=this.message_list.find_root(a);if(a!=d){var e=this.message_list.rows[d];if(b=="read"&&e.unread_children)e.unread_children--;else if(b=="unread"&&e.has_children)e.unread_children=e.unread_children?e.unread_children+1:1;else return;this.set_message_icon(d);this.set_unread_children(d)}}};this.update_thread=function(a){if(!this.env.threading)return 0;var b,d=0,
e=this.message_list.rows,g=e[a],f=e[a].depth,h=[];if(g.depth){if(g.unread){a=this.message_list.find_root(a);e[a].unread_children--;this.set_unread_children(a)}}else d--;a=g.parent_uid;for(g=g.obj.nextSibling;g;){if(g.nodeType==1&&(b=e[g.uid])){if(!b.depth||b.depth<=f)break;b.depth--;$("#rcmtab"+b.uid).width(b.depth*15).html("");if(b.depth){if(b.depth==f)b.parent_uid=a;b.unread&&h.length&&h[h.length-1].unread_children++}else{d++;b.parent_uid=0;if(b.has_children){$("#rcmrow"+b.uid+" .leaf:first").attr("id",
"rcmexpando"+b.uid).attr("class",b.obj.style.display!="none"?"expanded":"collapsed").bind("mousedown",{uid:b.uid,p:this},function(j){return j.data.p.expand_message_row(j,j.data.uid)});b.unread_children=0;h.push(b)}b.obj.style.display=="none"&&$(b.obj).show()}}g=g.nextSibling}for(b=0;b<h.length;b++)this.set_unread_children(h[b].uid);return d};this.delete_excessive_thread_rows=function(){for(var a=this.message_list.rows,b=this.message_list.list.tBodies[0].firstChild,d=this.env.pagesize+1;b;){if(b.nodeType==
1&&(r=a[b.uid])){!r.depth&&d&&d--;d||this.message_list.remove_row(b.uid)}b=b.nextSibling}};this.set_message_icon=function(a){var b=this.message_list.rows[a];if(!b)return false;if(b.icon){a="msgicon";if(b.deleted)a+=" deleted";else if(b.unread)a+=" unread";else if(b.unread_children)a+=" unreadchildren";if(b.msgicon==b.icon){if(b.replied)a+=" replied";if(b.forwarded)a+=" forwarded";a+=" status"}b.icon.className=a}if(b.msgicon&&b.msgicon!=b.icon){a="msgicon";if(!b.unread&&b.unread_children)a+=" unreadchildren";
if(b.replied)a+=" replied";if(b.forwarded)a+=" forwarded";b.msgicon.className=a}if(b.flagicon){a=b.flagged?"flagged":"unflagged";b.flagicon.className=a}};this.set_message_status=function(a,b,d){a=this.message_list.rows[a];if(!a)return false;if(b=="unread")a.unread=d;else if(b=="deleted")a.deleted=d;else if(b=="replied")a.replied=d;else if(b=="forwarded")a.forwarded=d;else if(b=="flagged")a.flagged=d};this.set_message=function(a,b,d){var e=this.message_list&&this.message_list.rows[a];if(!e)return false;
b&&this.set_message_status(a,b,d);b=$(e.obj);if(e.unread&&!b.hasClass("unread"))b.addClass("unread");else!e.unread&&b.hasClass("unread")&&b.removeClass("unread");if(e.deleted&&!b.hasClass("deleted"))b.addClass("deleted");else!e.deleted&&b.hasClass("deleted")&&b.removeClass("deleted");if(e.flagged&&!b.hasClass("flagged"))b.addClass("flagged");else!e.flagged&&b.hasClass("flagged")&&b.removeClass("flagged");this.set_unread_children(a);this.set_message_icon(a)};this.set_unread_children=function(a){a=
this.message_list.rows[a];a.parent_uid||(!a.unread&&a.unread_children&&!a.expanded?$(a.obj).addClass("unroot"):$(a.obj).removeClass("unroot"))};this.copy_messages=function(a){if(a&&typeof a==="object")a=a.id;if(!(!a||a==this.env.mailbox)){a=this.selection_post_data({_target_mbox:a});a._uid&&this.http_post("copy",a,this.display_message(this.get_label("copyingmessage"),"loading"))}};this.move_messages=function(a){if(a&&typeof a==="object")a=a.id;if(!(!a||a==this.env.mailbox)){var b=false;a=this.selection_post_data({_target_mbox:a});
if(a._uid){if(this.env.action=="show")b=this.set_busy(true,"movingmessage");else this.show_contentframe(false);this.enable_command(this.env.message_commands,false);this._with_selected_messages("moveto",a,b)}}};this.delete_messages=function(a){var b,d,e,g=this.env.trash_mailbox,f=this.message_list,h=f?f.get_selection():[];if(this.env.uid||h.length){d=0;for(e=h.length;d<e;d++){b=h[d];f.rows[b].has_children&&!f.rows[b].expanded&&f.select_children(b)}if(this.env.flag_for_deletion){this.mark_message("delete");
return false}else if(!g||this.env.mailbox==g)this.permanently_remove_messages();else if(this.env.delete_junk&&this.env.junk_mailbox&&this.env.mailbox==this.env.junk_mailbox)this.permanently_remove_messages();else if(f&&f.modkey==SHIFT_KEY||a&&rcube_event.get_modifier(a)==SHIFT_KEY)confirm(this.get_label("deletemessagesconfirm"))&&this.permanently_remove_messages();else this.move_messages(g);return true}};this.permanently_remove_messages=function(){var a=this.selection_post_data();if(a._uid){this.show_contentframe(false);
this._with_selected_messages("delete",a)}};this._with_selected_messages=function(a,b,d){var e=0;if(this.message_list){var g,f,h,j=[],m=this.message_list.get_selection();g=0;for(len=m.length;g<len;g++){f=m[g];if(this.env.threading){e+=this.update_thread(f);h=this.message_list.find_root(f);h!=f&&$.inArray(h,j)<0&&j.push(h)}this.message_list.remove_row(f,this.env.display_next&&g==m.length-1)}this.env.display_next||this.message_list.clear_selection();g=0;for(len=j.length;g<len;g++)this.add_tree_icons(j[g])}if(this.env.display_next&&
this.env.next_uid)b._next_uid=this.env.next_uid;if(e<0)b._count=e*-1;else e>0&&this.delete_excessive_thread_rows();if(!d){d=a=="moveto"?"movingmessage":"deletingmessage";d=this.display_message(this.get_label(d),"loading")}this.http_post(a,b,d)};this.selection_post_data=function(a){if(typeof a!="object")a={};a._mbox=this.env.mailbox;if(!a._uid){var b=this.env.uid?[this.env.uid]:this.message_list.get_selection();a._uid=this.uids_to_list(b)}if(this.env.action)a._from=this.env.action;if(this.env.search_request)a._search=
this.env.search_request;return a};this.mark_message=function(a,b){var d=[],e=[],g,f,h,j=this.message_list;if(b)d[0]=b;else if(this.env.uid)d[0]=this.env.uid;else if(j)d=j.get_selection();if(j){j.focus();f=0;for(g=d.length;f<g;f++){h=d[f];if(a=="read"&&j.rows[h].unread||a=="unread"&&!j.rows[h].unread||a=="delete"&&!j.rows[h].deleted||a=="undelete"&&j.rows[h].deleted||a=="flagged"&&!j.rows[h].flagged||a=="unflagged"&&j.rows[h].flagged)e.push(h)}}else e=d;if(e.length||this.select_all_mode)switch(a){case "read":case "unread":this.toggle_read_status(a,
e);break;case "delete":case "undelete":this.toggle_delete_status(e);break;case "flagged":case "unflagged":this.toggle_flagged_status(a,d)}};this.toggle_read_status=function(a,b){var d,e=b.length,g=this.selection_post_data({_uid:this.uids_to_list(b),_flag:a}),f=this.display_message(this.get_label("markingmessage"),"loading");for(d=0;d<e;d++)this.set_message(b[d],"unread",a=="unread"?true:false);this.http_post("mark",g,f);for(d=0;d<e;d++)this.update_thread_root(b[d],a)};this.toggle_flagged_status=function(a,
b){var d,e=b.length,g=this.selection_post_data({_uid:this.uids_to_list(b),_flag:a}),f=this.display_message(this.get_label("markingmessage"),"loading");for(d=0;d<e;d++)this.set_message(b[d],"flagged",a=="flagged"?true:false);this.http_post("mark",g,f)};this.toggle_delete_status=function(a){var b=a.length,d,e,g=true,f=this.message_list?this.message_list.rows:[];if(b==1){!f.length||f[a[0]]&&!f[a[0]].deleted?this.flag_as_deleted(a):this.flag_as_undeleted(a);return true}for(d=0;d<b;d++){e=a[d];if(f[e]&&
!f[e].deleted){g=false;break}}g?this.flag_as_undeleted(a):this.flag_as_deleted(a);return true};this.flag_as_undeleted=function(a){var b,d=a.length,e=this.selection_post_data({_uid:this.uids_to_list(a),_flag:"undelete"}),g=this.display_message(this.get_label("markingmessage"),"loading");for(b=0;b<d;b++)this.set_message(a[b],"deleted",false);this.http_post("mark",e,g)};this.flag_as_deleted=function(a){for(var b=[],d=this.selection_post_data({_uid:this.uids_to_list(a),_flag:"delete"}),e=this.display_message(this.get_label("markingmessage"),
"loading"),g=this.message_list?this.message_list.rows:[],f=0,h=0,j=a.length;h<j;h++){uid=a[h];if(g[uid]){if(g[uid].unread)b[b.length]=uid;if(this.env.skip_deleted){f+=this.update_thread(uid);this.message_list.remove_row(uid,this.env.display_next&&h==this.message_list.selection.length-1)}else this.set_message(uid,"deleted",true)}}if(this.env.skip_deleted&&this.message_list){this.env.display_next||this.message_list.clear_selection();if(f<0)d._count=f*-1;else f>0&&this.delete_excessive_thread_rows()}if(b.length)d._ruid=
this.uids_to_list(b);if(this.env.skip_deleted&&this.env.display_next&&this.env.next_uid)d._next_uid=this.env.next_uid;this.http_post("mark",d,e)};this.flag_deleted_as_read=function(a){var b,d,e,g=this.message_list?this.message_list.rows:[];a=String(a).split(",");d=0;for(e=a.length;d<e;d++){b=a[d];g[b]&&this.set_message(b,"unread",false)}};this.uids_to_list=function(a){return this.select_all_mode?"*":a.join(",")};this.set_button_titles=function(){var a="deletemessage";if(!this.env.flag_for_deletion&&
this.env.trash_mailbox&&this.env.mailbox!=this.env.trash_mailbox&&(!this.env.delete_junk||!this.env.junk_mailbox||this.env.mailbox!=this.env.junk_mailbox))a="movemessagetotrash";this.set_alttext("delete",a)};this.expunge_mailbox=function(a){var b,d={_mbox:a};if(a==this.env.mailbox){b=this.set_busy(true,"loading");d._reload=1;if(this.env.search_request)d._search=this.env.search_request}this.http_post("expunge",d,b)};this.purge_mailbox=function(a){var b,d={_mbox:a};if(!confirm(this.get_label("purgefolderconfirm")))return false;
if(a==this.env.mailbox){b=this.set_busy(true,"loading");d._reload=1}this.http_post("purge",d,b)};this.purge_mailbox_test=function(){return this.env.exists&&(this.env.mailbox==this.env.trash_mailbox||this.env.mailbox==this.env.junk_mailbox||this.env.mailbox.match("^"+RegExp.escape(this.env.trash_mailbox)+RegExp.escape(this.env.delimiter))||this.env.mailbox.match("^"+RegExp.escape(this.env.junk_mailbox)+RegExp.escape(this.env.delimiter)))};this.login_user_keyup=function(a){var b=rcube_event.get_keycode(a),
d=$("#rcmloginpwd");if(b==13&&d.length&&!d.val()){d.focus();return rcube_event.cancel(a)}return true};this.open_compose_step=function(a){a=this.url("mail/compose",a);if(this.env.compose_extwin&&!this.env.extwin)this.open_window(a,1150);else{this.redirect(a);this.env.extwin&&window.resizeTo(Math.max(1150,$(window).width()),$(window).height()+24)}};this.init_messageform=function(){if(!this.gui_objects.messageform)return false;var a=$("[name='_from']"),b=$("[name='_to']"),d=$("input[name='_subject']"),
e=$("[name='_message']").get(0),g=$("input[name='_is_html']").val()=="1",f=["cc","bcc","replyto","followupto"],h,j=this.opener();if(j&&j.env.action=="compose"){setTimeout(function(){opener.history.back()},100);this.env.opened_extwin=true}if(this.env.autocomplete_threads>0)h={threads:this.env.autocomplete_threads,sources:this.env.autocomplete_sources};this.init_address_input_events(b,h);for(var m in f)this.init_address_input_events($("[name='_"+f[m]+"']"),h);if(!g){this.set_caret_pos(e,this.env.top_posting?
0:$(e).val().length);a.prop("type")=="select-one"&&this.change_identity(a[0])}if(b.val()=="")b.focus();else if(d.val()=="")d.focus();else e&&e.focus();this.env.compose_focus_elem=document.activeElement;this.compose_field_hash(true);this.auto_save_start()};this.init_address_input_events=function(a,b){this.env.recipients_delimiter=this.env.recipients_separator+" ";a[bw.ie||bw.safari||bw.chrome?"keydown":"keypress"](function(d){return l.ksearch_keydown(d,this,b)}).attr("autocomplete","off")};this.submit_messageform=
function(a){var b=this.gui_objects.messageform;if(b){var d=this.set_busy(true,a?"savingmessage":"sendingmessage"),e=this.spellcheck_lang(),g=[];$("li",this.gui_objects.attachmentlist).each(function(){g.push(this.id.replace(/^rcmfile/,""))});$('input[name="_attachments"]',b).val(g.join());b.target="savetarget";b._draft.value=a?"1":"";b.action=this.add_url(b.action,"_unlock",d);b.action=this.add_url(b.action,"_lang",e);this.submit_timer=setTimeout(function(){l.set_busy(false,null,d);l.display_message(l.get_label("requesttimedout"),
"error")},this.env.request_timeout*1E3);b.submit()}};this.compose_recipient_select=function(a){this.enable_command("add-recipient",a.selection.length>0)};this.compose_add_recipient=function(a){var b=[],d=$("#_"+a),e=this.env.recipients_delimiter;if(this.contact_list&&this.contact_list.selection.length)for(var g,f=0;f<this.contact_list.selection.length;f++)if((g=this.contact_list.selection[f])&&this.env.contactdata[g]){b.push(this.env.contactdata[g]);if(g.charAt(0)=="E"&&this.env.contactdata[g].indexOf("@")<
0&&d.length){var h=g.substr(1);this.group2expand[h]={name:this.env.contactdata[g],input:d.get(0)};this.http_request("group-expand",{_source:this.env.source,_gid:h},false)}}if(b.length&&d.length){g=d.val();f=RegExp(RegExp.escape(e)+"\\s*$");if(g&&!f.test(g))g+=e+" ";d.val(g+b.join(e+" ")+e+" ");this.triggerEvent("add-recipient",{field:a,recipients:b})}};this.check_compose_input=function(a){var b,d=$("[name='_to']"),e=$("[name='_cc']"),g=$("[name='_bcc']"),f=$("[name='_from']"),h=$("[name='_subject']"),
j=$("[name='_message']");if(f.prop("type")=="text"&&!rcube_check_email(f.val(),true)){alert(this.get_label("nosenderwarning"));f.focus();return false}e=d.val()?d.val():e.val()?e.val():g.val();if(!rcube_check_email(e.replace(/^\s+/,"").replace(/[\s,;]+$/,""),true)){alert(this.get_label("norecipientwarning"));d.focus();return false}for(var m in this.env.attachments)if(typeof this.env.attachments[m]==="object"&&!this.env.attachments[m].complete){alert(this.get_label("notuploadedwarning"));return false}if(h.val()==
""){b=$('<div class="prompt">').html('<div class="message">'+this.get_label("nosubjectwarning")+"</div>").appendTo(document.body);var k=$("<input>").attr("type","text").attr("size",30).appendTo(b).val(this.get_label("nosubject"));d={};d[this.get_label("cancel")]=function(){h.focus();$(this).dialog("close")};d[this.get_label("sendmessage")]=function(){h.val(k.val());$(this).dialog("close");l.command(a,{nocheck:true})};b.dialog({modal:true,resizable:false,buttons:d,close:function(){$(this).remove()}});
k.select();return false}this.stop_spellchecking();if(window.tinyMCE)b=tinyMCE.get(this.env.composebody);if(!b&&j.val()==""&&!confirm(this.get_label("nobodywarning"))){j.focus();return false}else if(b){if(!b.getContent()&&!confirm(this.get_label("nobodywarning"))){b.focus();return false}tinyMCE.triggerSave()}return true};this.toggle_editor=function(a){this.stop_spellchecking();if(a.mode=="html"){this.plain2html($("#"+a.id).val(),a.id);tinyMCE.execCommand("mceAddControl",false,a.id);this.env.default_font&&
setTimeout(function(){$(tinyMCE.get(a.id).getBody()).css("font-family",rcmail.env.default_font)},500)}else{var b;if(b=tinyMCE.get(a.id).getContent()){if(!confirm(this.get_label("editorwarning")))return false;this.html2plain(b,a.id)}tinyMCE.execCommand("mceRemoveControl",false,a.id)}return true};this.stop_spellchecking=function(){var a;if(window.tinyMCE&&(a=tinyMCE.get(this.env.composebody)))a.plugins&&a.plugins.spellchecker&&a.plugins.spellchecker.active&&a.execCommand("mceSpellCheck");else if(a=
this.env.spellcheck)a.state&&a.state!="ready"&&a.state!="no_error_found"&&$(a.spell_span).trigger("click");this.spellcheck_state()};this.spellcheck_state=function(){var a,b;if(window.tinyMCE&&(a=tinyMCE.get(this.env.composebody))&&a.plugins&&a.plugins.spellchecker)b=a.plugins.spellchecker.active;else if((a=this.env.spellcheck)&&a.state)b=a.state!="ready"&&a.state!="no_error_found";if(rcmail.buttons.spellcheck)$("#"+rcmail.buttons.spellcheck[0].id)[b?"addClass":"removeClass"]("selected");return b};
this.spellcheck_lang=function(){var a;if(window.tinyMCE&&(a=tinyMCE.get(this.env.composebody))&&a.plugins&&a.plugins.spellchecker)return a.plugins.spellchecker.selectedLang;else if(this.env.spellcheck)return GOOGIE_CUR_LANG};this.spellcheck_lang_set=function(a){var b;if(window.tinyMCE&&(b=tinyMCE.get(this.env.composebody))&&b.plugins)b.plugins.spellchecker.selectedLang=a;else this.env.spellcheck&&this.env.spellcheck.setCurrentLanguage(a)};this.spellcheck_resume=function(a,b){if(a){var d=tinyMCE.get(this.env.composebody);
e=d.plugins.spellchecker;e.active=1;e._markWords(b);d.nodeChanged()}else{var e=this.env.spellcheck;e.prepare(false,true);e.processData(b)}this.spellcheck_state()};this.set_draft_id=function(a){var b;if(!this.env.draft_id&&a&&(b=this.opener()))b.env.task=="mail"&&b.env.action==""&&b.env.mailbox==this.env.drafts_mailbox&&b.command("checkmail");this.env.draft_id=a;$("input[name='_draft_saveid']").val(a)};this.auto_save_start=function(){if(this.env.draft_autosave)this.save_timer=setTimeout(function(){l.command("savedraft")},
this.env.draft_autosave*1E3);this.busy=false};this.compose_field_hash=function(a){var b,d,e,g="",f=["to","cc","bcc","subject"];for(d=0;d<f.length;d++)if(e=$('[name="_'+f[d]+'"]').val())g+=e+":";g+=window.tinyMCE&&(b=tinyMCE.get(this.env.composebody))?b.getContent():$("[name='_message']").val();if(this.env.attachments)for(var h in this.env.attachments)g+=h;if(a)this.cmp_hash=g;return g};this.change_identity=function(a,b){if(!a||!a.options)return false;if(!b)b=this.env.show_sig;if(!this.env.identities_initialized){this.env.identities_initialized=
true;if(this.env.show_sig_later)this.env.show_sig=true;if(this.env.opened_extwin)return}var d;d=-1;var e=a.options[a.selectedIndex].value,g=$("[name='_message']"),f=g.val(),h=$("input[name='_is_html']").val()=="1",j=this.env.identity;if(this.env.signatures&&this.env.signatures[e]){this.enable_command("insert-sig",true);this.env.compose_commands.push("insert-sig")}else this.enable_command("insert-sig",false);if(h){if(b&&this.env.signatures){d=tinyMCE.get(this.env.composebody);g=d.dom.get("_rc_sig");
if(!g){f=d.getBody();j=d.getDoc();g=j.createElement("div");g.setAttribute("id","_rc_sig");if(this.env.top_posting){d.getWin().focus();d=d.selection.getNode();if(d.nodeName=="BODY"){f.insertBefore(g,f.firstChild);f.insertBefore(j.createElement("br"),f.firstChild)}else{f.insertBefore(g,d.nextSibling);f.insertBefore(j.createElement("br"),d.nextSibling)}}else{bw.ie&&f.appendChild(j.createElement("br"));f.appendChild(g)}}if(this.env.signatures[e])g.innerHTML=this.env.signatures[e].html}}else{if(b&&j&&
this.env.signatures&&this.env.signatures[j]){j=this.env.signatures[j].text;j=j.replace(/\r\n/g,"\n");d=this.env.top_posting?f.indexOf(j):f.lastIndexOf(j);if(d>=0)f=f.substring(0,d)+f.substring(d+j.length,f.length)}if(b&&this.env.signatures&&this.env.signatures[e]){j=this.env.signatures[e].text;j=j.replace(/\r\n/g,"\n");if(this.env.top_posting)if(d>=0){f=f.substring(0,d)+j+f.substring(d,f.length);d=d-1}else if(f)if(pos=this.get_caret_pos(g.get(0))){f=f.substring(0,pos)+"\n"+j+"\n\n"+f.substring(pos,
f.length);d=pos}else{d=0;f="\n\n"+j+"\n\n"+f.replace(/^[\r\n]+/,"")}else{d=0;f="\n\n"+j}else{f=f.replace(/[\r\n]+$/,"");d=!this.env.top_posting&&f.length?f.length+1:0;f+="\n\n"+j}}else d=this.env.top_posting?0:f.length;g.val(f);this.set_caret_pos(g.get(0),d)}this.env.identity=e;return true};this.upload_file=function(a){if(!a)return false;var b=0,d=0;$("input[type=file]",a).each(function(h,j){var m=j.files?j.files.length:j.value?1:0;if(j.files)for(h=0;h<m;h++)b+=j.files[h].size;d+=m});if(d){if(this.env.max_filesize&&
this.env.filesizeerror&&b>this.env.max_filesize){this.display_message(this.env.filesizeerror,"error");return}var e=this.async_upload_form(a,"upload",function(h){var j,m="";try{if(this.contentDocument)j=this.contentDocument;else if(this.contentWindow)j=this.contentWindow.document;m=j.childNodes[0].innerHTML}catch(k){}if(!m.match(/add2attachment/)&&(!bw.opera||rcmail.env.uploadframe&&rcmail.env.uploadframe==h.data.ts)){m.match(/display_message/)||rcmail.display_message(rcmail.get_label("fileuploaderror"),
"error");rcmail.remove_from_attachment_list(h.data.ts)}if(bw.opera)rcmail.env.uploadframe=h.data.ts}),g="<span>"+this.get_label("uploading"+(d>1?"many":""))+"</span>",f=e.replace(/^rcmupload/,"");this.add2attachment_list(f,{name:"",html:g,classname:"uploading",frame:e,complete:false});this.env.upload_progress_time&&this.upload_progress_start("upload",f)}this.gui_objects.attachmentform=a;return true};this.add2attachment_list=function(a,b,d){if(!this.gui_objects.attachmentlist)return false;if(!b.complete&&
l.env.loadingicon)b.html='<img src="'+l.env.loadingicon+'" alt="" class="uploading" />'+b.html;if(!b.complete&&b.frame)b.html='<a title="'+this.get_label("cancel")+'" onclick="return rcmail.cancel_attachment_upload(\''+a+"', '"+b.frame+'\');" href="#cancelupload" class="cancelupload">'+(this.env.cancelicon?'<img src="'+this.env.cancelicon+'" alt="" />':this.get_label("cancel"))+"</a>"+b.html;var e,g=$("<li>");g.attr("id",a).addClass(b.classname).html(b.html).on("mouseover",function(){rcube_webmail.long_subject_title_ex(this,
0)});d&&(e=document.getElementById(d))?g.replaceAll(e):g.appendTo(this.gui_objects.attachmentlist);d&&this.env.attachments[d]&&delete this.env.attachments[d];this.env.attachments[a]=b;return true};this.remove_from_attachment_list=function(a){delete this.env.attachments[a];$("#"+a).remove()};this.remove_attachment=function(a){a&&this.env.attachments[a]&&this.http_post("remove-attachment",{_id:this.env.compose_id,_file:a});return true};this.cancel_attachment_upload=function(a,b){if(!a||!b)return false;
this.remove_from_attachment_list(a);$("iframe[name='"+b+"']").remove();return false};this.upload_progress_start=function(a,b){setTimeout(function(){rcmail.http_request(a,{_progress:b})},this.env.upload_progress_time*1E3)};this.upload_progress_update=function(a){var b=$("#"+a.name+"> span");if(b.length&&a.text){b.text(a.text);a.done||this.upload_progress_start(a.action,a.name)}};this.add_contact=function(a){a&&this.http_post("addcontact",{_address:a});return true};this.qsearch=function(a){if(a!=""){var b=
this.set_busy(true,"searching");a=this.search_params(a);if(this.message_list)this.clear_message_list();else this.contact_list&&this.list_contacts_clear();if(this.env.source)a._source=this.env.source;if(this.env.group)a._gid=this.env.group;this.env.current_page=1;a=this.http_request(this.env.action=="compose"&&this.contact_list?"search-contacts":"search",a,b);this.env.qsearch={lock:b,request:a}}};this.search_params=function(a,b){var d,e={},g=[],f=this.env.search_mods,h=this.env.mailbox;if(!b&&this.gui_objects.search_filter)b=
this.gui_objects.search_filter.value;if(!a&&this.gui_objects.qsearchbox)a=this.gui_objects.qsearchbox.value;if(b)e._filter=b;if(a){e._q=a;if(f&&this.message_list)f=f[h]?f[h]:f["*"];if(f){for(d in f)g.push(d);e._headers=g.join(",")}}if(h)e._mbox=h;return e};this.reset_qsearch=function(){if(this.gui_objects.qsearchbox)this.gui_objects.qsearchbox.value="";this.env.qsearch&&this.abort_request(this.env.qsearch);this.env.qsearch=null;this.env.search_request=null;this.env.search_id=null};this.sent_successfully=
function(a,b,d){this.display_message(b,a);if(this.env.extwin){var e=this.opener();this.lock_form(this.gui_objects.messageform);if(e){e.display_message(b,a);d&&e.env.task=="mail"&&e.env.action==""&&e.env.mailbox==d&&e.command("checkmail")}setTimeout(function(){window.close()},1E3)}else setTimeout(function(){l.list_mailbox()},500)};this.ksearch_keydown=function(a,b,d){this.ksearch_timer&&clearTimeout(this.ksearch_timer);var e=rcube_event.get_keycode(a),g=rcube_event.get_modifier(a);switch(e){case 38:case 40:if(!this.ksearch_visible())break;
e=e==38?1:0;b=document.getElementById("rcmksearchSelected");if(!b)b=this.ksearch_pane.__ul.firstChild;if(b)this.ksearch_select(e?b.previousSibling:b.nextSibling);return rcube_event.cancel(a);case 9:if(g==SHIFT_KEY||!this.ksearch_visible()){this.ksearch_hide();return}case 13:if(!this.ksearch_visible())return false;this.insert_recipient(this.ksearch_selected);this.ksearch_hide();return rcube_event.cancel(a);case 27:this.ksearch_hide();return;case 37:case 39:if(g!=SHIFT_KEY)return}this.ksearch_timer=
setTimeout(function(){l.ksearch_get_results(d)},200);this.ksearch_input=b;return true};this.ksearch_visible=function(){return this.ksearch_selected!==null&&this.ksearch_selected!==undefined&&this.ksearch_value};this.ksearch_select=function(a){var b=$("#rcmksearchSelected");b[0]&&a&&b.removeAttr("id").removeClass("selected");if(a){$(a).attr("id","rcmksearchSelected").addClass("selected");this.ksearch_selected=a._rcm_id}};this.insert_recipient=function(a){if(!(a===null||!this.env.contacts[a]||!this.ksearch_input)){var b=
this.ksearch_input.value,d=this.get_caret_pos(this.ksearch_input);d=b.lastIndexOf(this.ksearch_value,d);var e=false,g="",f=b.substring(0,d);b=b.substring(d+this.ksearch_value.length,b.length);this.ksearch_destroy();if(typeof this.env.contacts[a]==="object"&&this.env.contacts[a].id){g+=this.env.contacts[a].name+this.env.recipients_delimiter;this.group2expand[this.env.contacts[a].id]=$.extend({input:this.ksearch_input},this.env.contacts[a]);this.http_request("mail/group-expand",{_source:this.env.contacts[a].source,
_gid:this.env.contacts[a].id},false)}else if(typeof this.env.contacts[a]==="string"){g=this.env.contacts[a]+this.env.recipients_delimiter;e=true}this.ksearch_input.value=f+g+b;d=d+g.length;this.ksearch_input.setSelectionRange&&this.ksearch_input.setSelectionRange(d,d);e&&this.triggerEvent("autocomplete_insert",{field:this.ksearch_input,insert:g})}};this.replace_group_recipients=function(a,b){if(this.group2expand[a]){this.group2expand[a].input.value=this.group2expand[a].input.value.replace(this.group2expand[a].name,
b);this.triggerEvent("autocomplete_insert",{field:this.group2expand[a].input,insert:b});this.group2expand[a]=null}};this.ksearch_get_results=function(a){var b=this.ksearch_input?this.ksearch_input.value:null;if(b!==null){this.ksearch_pane&&this.ksearch_pane.is(":visible")&&this.ksearch_pane.hide();var d=this.get_caret_pos(this.ksearch_input),e=b.lastIndexOf(this.env.recipients_separator,d-1);b=b.substring(e+1,d);e=this.env.autocomplete_min_length;d=this.ksearch_data;b=$.trim(b);if(b!=this.ksearch_value){this.ksearch_destroy();
if(b.length&&b.length<e){if(!this.ksearch_info)this.ksearch_info=this.display_message(this.get_label("autocompletechars").replace("$min",e))}else{e=this.ksearch_value;this.ksearch_value=b;if(b.length)if(!(e&&e.length&&b.indexOf(e)==0&&(!d||d.num<=0)&&this.env.contacts&&!this.env.contacts.length)){var g,f;e=(new Date).getTime();b={_search:b,_id:e};d=a&&a.threads?a.threads:1;g=a&&a.sources?a.sources:[];a=a&&a.action?a.action:"mail/autocomplete";this.ksearch_data={id:e,sources:g.slice(),action:a,locks:[],
requests:[],num:g.length};for(e=0;e<d;e++){g=this.ksearch_data.sources.shift();if(d>1&&g===undefined)break;b._source=g?g:"";g=this.display_message(this.get_label("searching"),"loading");f=this.http_post(a,b,g);this.ksearch_data.locks.push(g);this.ksearch_data.requests.push(f)}}}}}};this.ksearch_query_results=function(a,b,d){if(this.ksearch_value)if(!(this.ksearch_input&&b!=this.ksearch_value)){var e,g,f,h,j,m=this.ksearch_value;b=this.ksearch_data;var k=this.env.autocomplete_max?this.env.autocomplete_max:
15;if(!this.ksearch_pane){f=$("<ul>");this.ksearch_pane=$("<div>").attr("id","rcmKSearchpane").css({position:"absolute","z-index":3E4}).append(f).appendTo(document.body);this.ksearch_pane.__ul=f[0]}f=this.ksearch_pane.__ul;if(d&&this.ksearch_pane.data("reqid")==d)k-=f.childNodes.length;else{this.ksearch_pane.data("reqid",d);f.innerHTML="";this.env.contacts=[];e=$(this.ksearch_input).offset();this.ksearch_pane.css({left:e.left+"px",top:e.top+this.ksearch_input.offsetHeight+"px",display:"none"})}if(a&&
(g=a.length))for(e=0;e<g&&k>0;e++){j=typeof a[e]==="object"?a[e].name:a[e];h=document.createElement("LI");h.innerHTML=j.replace(RegExp("("+RegExp.escape(m)+")","ig"),"##$1%%").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/##([^%]+)%%/g,"<b>$1</b>");h.onmouseover=function(){l.ksearch_select(this)};h.onmouseup=function(){l.ksearch_click(this)};h._rcm_id=this.env.contacts.length+e;f.appendChild(h);k-=1}if(f.childNodes.length){this.ksearch_pane.show();if(!this.env.contacts.length){$("li:first",f).attr("id",
"rcmksearchSelected").addClass("selected");this.ksearch_selected=0}}if(g)this.env.contacts=this.env.contacts.concat(a);if(b.id==d){b.num--;if(k>0&&b.sources.length){if(a=b.sources.shift()){a={_search:m,_id:d,_source:a};d=this.display_message(this.get_label("searching"),"loading");b=this.http_post(b.action,a,d);this.ksearch_data.locks.push(d);this.ksearch_data.requests.push(b)}}else if(!k){if(!this.ksearch_msg)this.ksearch_msg=this.display_message(this.get_label("autocompletemore"));this.ksearch_abort()}}}};
this.ksearch_click=function(a){this.ksearch_input&&this.ksearch_input.focus();this.insert_recipient(a._rcm_id);this.ksearch_hide()};this.ksearch_blur=function(){this.ksearch_timer&&clearTimeout(this.ksearch_timer);this.ksearch_input=null;this.ksearch_hide()};this.ksearch_hide=function(){this.ksearch_selected=null;this.ksearch_value="";this.ksearch_pane&&this.ksearch_pane.hide();this.ksearch_destroy()};this.ksearch_destroy=function(){this.ksearch_abort();this.ksearch_info&&this.hide_message(this.ksearch_info);
this.ksearch_msg&&this.hide_message(this.ksearch_msg);this.ksearch_msg=this.ksearch_info=this.ksearch_data=null};this.ksearch_abort=function(){var a,b,d=this.ksearch_data;if(d){a=0;for(b=d.locks.length;a<b;a++)this.abort_request({request:d.requests[a],lock:d.locks[a]})}};this.contactlist_keypress=function(a){a.key_pressed==a.DELETE_KEY&&this.command("delete")};this.contactlist_select=function(a){this.preview_timer&&clearTimeout(this.preview_timer);var b,d,e,g=this,f=false;e=this.env.source?this.env.address_sources[this.env.source]:
null;if(d=a.get_single_selection())this.preview_timer=setTimeout(function(){g.load_contact(d,"show")},200);else this.env.contentframe&&this.show_contentframe(false);if(a.selection.length){this.env.selection_sources=[];if(e){this.env.selection_sources.push(this.env.source);f=!e.readonly}else{for(b in a.selection)if((e=String(a.selection[b]).replace(/^[^-]+-/,""))&&this.env.address_sources[e]){f=f||!this.env.address_sources[e].readonly;this.env.selection_sources.push(e)}this.env.selection_sources=$.unique(this.env.selection_sources)}}this.enable_command("group-remove-selected",
this.env.group&&a.selection.length>0);this.enable_command("compose",this.env.group||a.selection.length>0);this.enable_command("edit",d&&f);this.enable_command("delete",a.selection.length&&f);return false};this.list_contacts=function(a,b,d){var e,g={},f=window;if(!a)a=this.env.source;if(d&&this.current_page==d&&a==this.env.source&&b==this.env.group)return false;if(a!=this.env.source){d=this.env.current_page=1;this.reset_qsearch()}else if(b!=this.env.group)d=this.env.current_page=1;if(this.env.search_id)e=
"S"+this.env.search_id;else this.env.search_request||(e=b?"G"+a+b:a);this.select_folder(e);this.env.source=a;this.env.group=b;if(this.gui_objects.contactslist)this.list_contacts_remote(a,b,d);else{if(e=this.get_frame_window(this.env.contentframe)){f=e;g._framed=1}if(b)g._gid=b;if(d)g._page=d;if(a)g._source=a;if(this.env.search_request)g._search=this.env.search_request;this.set_busy(true,"loading");this.location_href(g,f)}};this.list_contacts_remote=function(a,b,d){this.list_contacts_clear();var e=
{},g=this.set_busy(true,"loading");if(a)e._source=a;if(d)e._page=d;if(b)e._gid=b;this.env.source=a;this.env.group=b;if(this.env.search_request)e._search=this.env.search_request;this.http_request(this.env.task=="mail"?"list-contacts":"list",e,g)};this.list_contacts_clear=function(){this.contact_list.clear(true);this.show_contentframe(false);this.enable_command("delete",false);this.enable_command("compose",this.env.group?true:false)};this.load_contact=function(a,b,d){var e,g={},f=window;if(e=this.get_frame_window(this.env.contentframe)){g._framed=
1;f=e;this.show_contentframe(true);if(!a){this.contact_list.clear_selection();this.enable_command("delete","compose",false)}}else if(d)return false;if(b&&(a||b=="add")&&!this.drag_active){if(this.env.group)g._gid=this.env.group;g._action=b;g._source=this.env.source;g._cid=a;this.location_href(g,f,true)}return true};this.group_member_change=function(a,b,d,e){a=a=="add"?"add":"del";var g=this.display_message(this.get_label(a=="add"?"addingmember":"removingmember"),"loading");this.http_post("group-"+
a+"members",{_cid:b,_source:d,_gid:e},g)};this.copy_contact=function(a,b){var d=b.type=="group"?b.source:b.id,e=this.env.source,g=this.env.group?this.env.group:"";a||(a=this.contact_list.get_selection().join(","));if(!(!a||!this.env.address_sources[d]||this.env.address_sources[d].readonly)){if(e==""&&this.env.selection_sources.length==1)e=this.env.selection_sources[0];if(b.type=="group")if(d==e)this.group_member_change("add",a,d,b.id);else{e=this.display_message(this.get_label("copyingcontact"),"loading");
d={_cid:a,_source:this.env.source,_to:d,_togid:b.id,_gid:g};this.http_post("copy",d,e)}else if(b.id!=e){e=this.display_message(this.get_label("copyingcontact"),"loading");d={_cid:a,_source:this.env.source,_to:b.id,_gid:g};this.http_post("copy",d,e)}}};this.delete_contacts=function(){var a=this.contact_list.get_selection(),b=this.env.source&&this.env.address_sources[this.env.source].undelete;if(!(!(a.length||this.env.cid)||!b&&!confirm(this.get_label("deletecontactconfirm")))){var d,e=[],g={_source:this.env.source,
_from:this.env.action?this.env.action:""},f=this.display_message(this.get_label("contactdeleting"),"loading");if(this.env.cid)e.push(this.env.cid);else{for(d=0;d<a.length;d++){b=a[d];e.push(b);this.contact_list.remove_row(b,d==a.length-1)}a.length==1&&this.show_contentframe(false)}g._cid=e.join(",");if(this.env.group)g._gid=this.env.group;if(this.env.search_request)g._search=this.env.search_request;this.http_post("delete",g,f);return true}};this.update_contact_row=function(a,b,d,e){var g,f=this.contact_list;
a=this.html_identifier(a);if(!f.rows[a]){a=a+"-"+e;if(d)d=d+"-"+e}if(f.rows[a]&&(g=f.rows[a].obj)){for(e=0;e<b.length;e++)g.cells[e]&&$(g.cells[e]).html(b[e]);if(d){d=this.html_identifier(d);g.id="rcmrow"+d;f.remove_row(a);f.init_row(g);f.selection[0]=d;g.style.display=""}}};this.add_contact_row=function(a,b,d){if(!this.gui_objects.contactslist)return false;var e,g=this.contact_list,f=document.createElement("tr");f.id="rcmrow"+this.html_identifier(a);f.className="contact "+(d||"");if(g.in_selection(a))f.className+=
" selected";for(e in b){a=document.createElement("td");a.className=String(e).toLowerCase();if(b[e])a.innerHTML=b[e];f.appendChild(a)}g.insert_row(f);this.enable_command("export",g.rowcount>0)};this.init_contact_form=function(){var a=this,b;if(this.env.coltypes){this.set_photo_actions($("#ff_photo").val());for(b in this.env.coltypes)this.init_edit_field(b,null)}$(".contactfieldgroup .row a.deletebutton").click(function(){a.delete_edit_field(this);return false});$("select.addfieldmenu").change(function(){a.insert_edit_field($(this).val(),
$(this).attr("rel"),this);this.selectedIndex=0});if($.datepicker&&this.env.date_format){$.datepicker.setDefaults({dateFormat:this.env.date_format,changeMonth:true,changeYear:true,yearRange:"-100:+10",showOtherMonths:true,selectOtherMonths:true,onSelect:function(d){$(this).focus().val(d)}});$("input.datepicker").datepicker()}$("input[type='text']:visible").first().focus();this.env.action=="search"&&$(this.gui_objects.editform).append($('<input type="submit">').hide()).submit(function(){$("input.mainaction").click();
return false})};this.group_create=function(){this.add_input_row("contactgroup")};this.group_rename=function(){if(this.env.group&&this.gui_objects.folderlist){if(!this.name_input){this.enable_command("list","listgroup",false);this.name_input=$("<input>").attr("type","text").val(this.env.contactgroups["G"+this.env.source+this.env.group].name);this.name_input.bind("keydown",function(d){return rcmail.add_input_keydown(d)});this.env.group_renaming=true;var a,b=this.get_folder_li(this.env.source+this.env.group,
"rcmliG");if(b&&(a=b.firstChild))$(a).hide().before(this.name_input)}this.name_input.select().focus()}};this.group_delete=function(){this.env.group&&confirm(this.get_label("deletegroupconfirm"))&&this.http_post("group-delete",{_source:this.env.source,_gid:this.env.group},this.set_busy(true,"groupdeleting"))};this.remove_group_item=function(a){var b,d="G"+a.source+a.id;if(b=this.get_folder_li(d)){this.triggerEvent("group_delete",{source:a.source,id:a.id,li:b});b.parentNode.removeChild(b);delete this.env.contactfolders[d];
delete this.env.contactgroups[d]}this.list_contacts(a.source,0)};this.add_input_row=function(a){if(this.gui_objects.folderlist){if(!this.name_input){this.name_input=$("<input>").attr("type","text").data("tt",a);this.name_input.bind("keydown",function(b){return rcmail.add_input_keydown(b)});this.name_input_li=$("<li>").addClass(a).append(this.name_input);this.name_input_li.insertAfter(a=="contactsearch"?$("li:last",this.gui_objects.folderlist):this.get_folder_li(this.env.source))}this.name_input.select().focus()}};
this.group_remove_selected=function(){l.http_post("group-delmembers",{_cid:this.contact_list.selection,_source:this.env.source,_gid:this.env.group})};this.remove_group_contacts=function(a){if("undefined"!=typeof this.env.group&&this.env.group===a.gid){var b=this.contact_list.get_selection();for(a=0;a<b.length;a++){id=b[a];this.contact_list.remove_row(id,a==b.length-1)}}};this.add_input_keydown=function(a){var b=rcube_event.get_keycode(a),d=$(a.target);a=d.data("tt");if(b==13){if(b=d.val()){d=this.set_busy(true,
"loading");if(a=="contactsearch")this.http_post("search-create",{_search:this.env.search_request,_name:b},d);else this.env.group_renaming?this.http_post("group-rename",{_source:this.env.source,_gid:this.env.group,_name:b},d):this.http_post("group-create",{_source:this.env.source,_name:b},d)}return false}else b==27&&this.reset_add_input();return true};this.reset_add_input=function(){if(this.name_input){if(this.env.group_renaming){this.name_input.parent().children().last().show();this.env.group_renaming=
false}this.name_input.remove();this.name_input_li&&this.name_input_li.remove();this.name_input=this.name_input_li=null}this.enable_command("list","listgroup",true)};this.insert_contact_group=function(a){this.reset_add_input();a.type="group";var b="G"+a.source+a.id,d=$("<a>").attr("href","#").attr("rel",a.source+":"+a.id).click(function(){return rcmail.command("listgroup",a,this)}).html(a.name);d=$("<li>").attr({id:"rcmli"+this.html_identifier(b),"class":"contactgroup"}).append(d);this.env.contactfolders[b]=
this.env.contactgroups[b]=a;this.add_contact_group_row(a,d);this.triggerEvent("group_insert",{id:a.id,source:a.source,name:a.name,li:d[0]})};this.update_contact_group=function(a){this.reset_add_input();var b="G"+a.source+a.id,d=this.get_folder_li(b),e;if(d&&a.newid){e="G"+a.source+a.newid;var g=$.extend({},a);d.id="rcmli"+this.html_identifier(e);this.env.contactfolders[e]=this.env.contactfolders[b];this.env.contactfolders[e].id=a.newid;this.env.group=a.newid;delete this.env.contactfolders[b];delete this.env.contactgroups[b];
g.id=a.newid;g.type="group";e=$("<a>").attr("href","#").attr("rel",a.source+":"+a.newid).click(function(){return rcmail.command("listgroup",g,this)}).html(a.name);$(d).children().replaceWith(e)}else if(d&&(e=d.firstChild)&&e.tagName.toLowerCase()=="a")e.innerHTML=a.name;this.env.contactfolders[b].name=this.env.contactgroups[b].name=a.name;this.add_contact_group_row(a,$(d),true);this.triggerEvent("group_update",{id:a.id,source:a.source,name:a.name,li:d[0],newid:a.newid})};this.add_contact_group_row=
function(a,b,d){var e=a.name.toUpperCase(),g=this.get_folder_li(a.source);a="rcmliG"+this.html_identifier(a.source);if(d){d=b.clone(true);b.remove()}else d=b;$('li[id^="'+a+'"]',this.gui_objects.folderlist).each(function(f,h){if(e>=$(this).text().toUpperCase())g=h;else return false});d.insertAfter(g)};this.update_group_commands=function(){var a=this.env.source!=""?this.env.address_sources[this.env.source]:null;this.enable_command("group-create",a&&a.groups&&!a.readonly);this.enable_command("group-rename",
"group-delete",a&&a.groups&&this.env.group&&!a.readonly)};this.init_edit_field=function(a,b){var d=this.env.coltypes[a].label;b||(b=$(".ff_"+a));d&&b.placeholder(d)};this.insert_edit_field=function(a,b,d){var e=$("#ff_"+a);if(e.length){e.show().focus();$(d).children('option[value="'+a+'"]').prop("disabled",true)}else{$(".ff_"+a);e=$("#contactsection"+b+" .contactcontroller"+a);if(!e.length){b=$("#contactsection"+b);var g=$(".contactfieldgroup",b).last();e=$("<fieldset>").addClass("contactfieldgroup contactcontroller"+
a);g.length?e.insertAfter(g):b.prepend(e)}if(e.length&&e.get(0).nodeName=="FIELDSET"){var f;b=this.env.coltypes[a];g=$("<div>").addClass("row");var h=$("<div>").addClass("contactfieldcontent data"),j=$("<div>").addClass("contactfieldlabel label");b.subtypes_select?j.html(b.subtypes_select):j.html(b.label);var m=b.limit!=1?"[]":"";if(b.type=="text"||b.type=="date"){f=$("<input>").addClass("ff_"+a).attr({type:"text",name:"_"+a+m,size:b.size}).appendTo(h);this.init_edit_field(a,f);b.type=="date"&&$.datepicker&&
f.datepicker()}else if(b.type=="textarea"){f=$("<textarea>").addClass("ff_"+a).attr({name:"_"+a+m,cols:b.size,rows:b.rows}).appendTo(h);this.init_edit_field(a,f)}else if(b.type=="composite"){var k,n,o=[],p=[];if(f=this.env[a+"_template"])for(k=0;k<f.length;k++){o.push(f[k][1]);p.push(f[k][2])}else for(k in b.childs)o.push(k);for(var q=0;q<o.length;q++){k=o[q];f=b.childs[k];f=$("<input>").addClass("ff_"+k).attr({type:"text",name:"_"+k+m,size:f.size}).appendTo(h);h.append(p[q]||" ");this.init_edit_field(k,
f);n||(n=f)}f=n}else if(b.type=="select"){f=$("<select>").addClass("ff_"+a).attr("name","_"+a+m).appendTo(h);var s=f.attr("options");s[s.length]=new Option("---","");b.options&&$.each(b.options,function(t,v){s[s.length]=new Option(v,t)})}if(f){$('<a href="#del"></a>').addClass("contactfieldbutton deletebutton").attr({title:this.get_label("delete"),rel:a}).html(this.env.delbutton).click(function(){l.delete_edit_field(this);return false}).appendTo(h);g.append(j).append(h).appendTo(e.show());f.first().focus();
if(!b.count)b.count=0;++b.count==b.limit&&b.limit&&$(d).children('option[value="'+a+'"]').prop("disabled",true)}}}};this.delete_edit_field=function(a){var b=$(a).attr("rel"),d=this.env.coltypes[b],e=$(a).parents("fieldset.contactfieldgroup"),g=e.parent().find("select.addfieldmenu");if(--d.count<=0&&d.visible)$(a).parent().children("input").val("").blur();else{$(a).parents("div.row").remove();e.children("div.row").length||e.hide()}if(g.length){a=g.children('option[value="'+b+'"]');a.length?a.prop("disabled",
false):$("<option>").attr("value",b).html(d.label).appendTo(g);g.show()}};this.upload_contact_photo=function(a){if(a&&a.elements._photo.value){this.async_upload_form(a,"upload-photo",function(){rcmail.set_busy(false,null,rcmail.file_upload_id)});this.file_upload_id=this.set_busy(true,"uploading")}};this.replace_contact_photo=function(a){var b=a=="-del-"?this.env.photo_placeholder:this.env.comm_path+"&_action=photo&_source="+this.env.source+"&_cid="+this.env.cid+"&_photo="+a;this.set_photo_actions(a);
$(this.gui_objects.contactphoto).children("img").attr("src",b)};this.photo_upload_end=function(){this.set_busy(false,null,this.file_upload_id);delete this.file_upload_id};this.set_photo_actions=function(a){var b,d=this.buttons["upload-photo"];for(b=0;d&&b<d.length;b++)$("a#"+d[b].id).html(this.get_label(a=="-del-"?"addphoto":"replacephoto"));$("#ff_photo").val(a);this.enable_command("upload-photo",this.env.coltypes.photo?true:false);this.enable_command("delete-photo",this.env.coltypes.photo&&a!="-del-")};
this.advanced_search=function(){var a,b={_form:1,_action:"search"},d=window;if(a=this.get_frame_window(this.env.contentframe)){b._framed=1;d=a;this.contact_list.clear_selection()}this.location_href(b,d,true);return true};this.unselect_directory=function(){this.select_folder("");this.enable_command("search-delete",false)};this.insert_saved_search=function(a,b){this.reset_add_input();var d="S"+b,e=$("<a>").attr("href","#").attr("rel",b).click(function(){return rcmail.command("listsearch",b,this)}).html(a);
d=$("<li>").attr({id:"rcmli"+this.html_identifier(d),"class":"contactsearch"}).append(e);e={name:a,id:b,li:d[0]};this.add_saved_search_row(e,d);this.select_folder("S"+b);this.enable_command("search-delete",true);this.env.search_id=b;this.triggerEvent("abook_search_insert",e)};this.add_saved_search_row=function(a,b,d){var e,g=a.name.toUpperCase();if(d){a=b.clone(true);b.remove()}else a=b;$('li[class~="contactsearch"]',this.gui_objects.folderlist).each(function(f,h){if(!e)e=this.previousSibling;if(g>=
$(this).text().toUpperCase())e=h;else return false});e?a.insertAfter(e):a.appendTo(this.gui_objects.folderlist)};this.search_create=function(){this.add_input_row("contactsearch")};this.search_delete=function(){this.env.search_request&&this.http_post("search-delete",{_sid:this.env.search_id},this.set_busy(true,"savedsearchdeleting"))};this.remove_search_item=function(a){var b;if(b=this.get_folder_li("S"+a)){this.triggerEvent("search_delete",{id:a,li:b});b.parentNode.removeChild(b)}this.env.search_id=
null;this.env.search_request=null;this.list_contacts_clear();this.reset_qsearch();this.enable_command("search-delete","search-create",false)};this.listsearch=function(a){var b=this.set_busy(true,"searching");this.contact_list&&this.list_contacts_clear();this.reset_qsearch();this.select_folder("S"+a);this.env.current_page=1;this.http_request("search",{_sid:a},b)};this.section_select=function(a){var b;b=a.get_single_selection();a=window;var d={_action:"edit-prefs",_section:b};if(b){if(b=this.get_frame_window(this.env.contentframe)){d._framed=
1;a=b}this.location_href(d,a,true)}return true};this.identity_select=function(a){var b;if(b=a.get_single_selection()){this.enable_command("delete",a.rowcount>1&&this.env.identities_level<2);this.load_identity(b,"edit-identity")}};this.load_identity=function(a,b){if(b=="edit-identity"&&(!a||a==this.env.iid))return false;var d,e=window,g={_action:b,_iid:a};if(d=this.get_frame_window(this.env.contentframe)){g._framed=1;e=d}if(b&&(a||b=="add-identity")){this.set_busy(true);this.location_href(g,e)}return true};
this.delete_identity=function(a){var b=this.identity_list.get_selection();if(b.length||this.env.iid){a||(a=this.env.iid?this.env.iid:b[0]);confirm(this.get_label("deleteidentityconfirm"))&&this.goto_url("delete-identity",{_iid:a,_token:this.env.request_token},true);return true}};this.update_identity_row=function(a,b,d){var e,g=this.identity_list;a=this.html_identifier(a);if(g.rows[a]&&(e=g.rows[a].obj))$(e.cells[0]).html(b);else if(d){e=$("<tr>").attr("id","rcmrow"+a).get(0);$("<td>").addClass("mail").html(b).appendTo(e);
g.insert_row(e);g.select(a)}};this.init_subscription_list=function(){var a=this;this.subscription_list=new rcube_list_widget(this.gui_objects.subscriptionlist,{multiselect:false,draggable:true,keyboard:false,toggleselect:true});this.subscription_list.addEventListener("select",function(b){a.subscription_select(b)});this.subscription_list.addEventListener("dragstart",function(){a.drag_active=true});this.subscription_list.addEventListener("dragend",function(b){a.subscription_move_folder(b)});this.subscription_list.row_init=
function(b){b.obj.onmouseover=function(){a.focus_subscription(b.id)};b.obj.onmouseout=function(){a.unfocus_subscription(b.id)}};this.subscription_list.init();$("#mailboxroot").mouseover(function(){a.focus_subscription(this.id)}).mouseout(function(){a.unfocus_subscription(this.id)})};this.focus_subscription=function(a){var b,d,e=RegExp.escape(this.env.delimiter);e=RegExp("["+e+"]?[^"+e+"]+$");if(this.drag_active&&this.env.mailbox&&(b=document.getElementById(a)))if(this.env.subscriptionrows[a]&&(d=
this.env.subscriptionrows[a][0])!==null)if(this.check_droptarget(d)&&!this.env.subscriptionrows[this.get_folder_row_id(this.env.mailbox)][2]&&d!=this.env.mailbox.replace(e,"")&&!d.match(RegExp("^"+RegExp.escape(this.env.mailbox+this.env.delimiter)))){this.env.dstfolder=d;$(b).addClass("droptarget")}};this.unfocus_subscription=function(a){var b=$("#"+a);this.env.dstfolder=null;this.env.subscriptionrows[a]&&b[0]?b.removeClass("droptarget"):$(this.subscription_list.frame).removeClass("droptarget")};
this.subscription_select=function(a){var b,d;if(a&&(b=a.get_single_selection())&&(d=this.env.subscriptionrows["rcmrow"+b])){this.env.mailbox=d[0];this.show_folder(d[0]);this.enable_command("delete-folder",!d[2])}else{this.env.mailbox=null;this.show_contentframe(false);this.enable_command("delete-folder","purge",false)}};this.subscription_move_folder=function(){var a=RegExp.escape(this.env.delimiter),b=RegExp("["+a+"]?[^"+a+"]+$");if(this.env.mailbox&&this.env.dstfolder!==null&&this.env.dstfolder!=
this.env.mailbox&&this.env.dstfolder!=this.env.mailbox.replace(b,"")){b=RegExp("[^"+a+"]*["+a+"]","g");a=this.env.mailbox.replace(b,"");a=this.env.dstfolder===""?a:this.env.dstfolder+this.env.delimiter+a;if(a!=this.env.mailbox){this.http_post("rename-folder",{_folder_oldname:this.env.mailbox,_folder_newname:a},this.set_busy(true,"foldermoving"));this.subscription_list.draglayer.hide()}}this.drag_active=false;this.unfocus_subscription(this.get_folder_row_id(this.env.dstfolder))};this.create_folder=
function(){this.show_folder("",this.env.mailbox)};this.delete_folder=function(a){if((a=this.env.subscriptionrows[this.get_folder_row_id(a?a:this.env.mailbox)][0])&&confirm(this.get_label("deletefolderconfirm"))){var b=this.set_busy(true,"folderdeleting");this.http_post("delete-folder",{_mbox:a},b)}};this.add_folder_row=function(a,b,d,e,g,f){if(!this.gui_objects.subscriptionlist)return false;var h,j,m,k,n,o=[],p=[],q=this.gui_objects.subscriptionlist.tBodies[0];h=$("tr",q).get(1);var s="rcmrow"+(new Date).getTime();
if(!h){this.goto_url("folders");return false}h=$(h).clone(true);h.attr("id",s);h.attr("class",f);h.find("td:first").html(b);$('input[name="_subscribed[]"]',h).val(a).prop({checked:e?true:false,disabled:d?true:false});this.env.subscriptionrows[s]=[a,b,0];k=[];$.each(this.env.subscriptionrows,function(t,v){k.push(v)});k.sort(function(t,v){return t[0]<v[0]?-1:t[0]>v[0]?1:0});for(j in k)if(k[j][2]){b=k[j][0]+this.env.delimiter;if(b!=this.env.prefix_ns){p.push(k[j][0]);m=b}}else if(m&&k[j][0].indexOf(m)==
0)p.push(k[j][0]);else{o.push(k[j][0]);m=null}for(j=0;j<p.length;j++)if(a.indexOf(p[j]+this.env.delimiter)==0)n=this.get_folder_row_id(p[j]);for(j=0;!n&&j<o.length;j++)if(j&&o[j]==a)n=this.get_folder_row_id(o[j-1]);n?$("#"+n).after(h):h.appendTo(q);this.subscription_list.clear_selection();g||this.init_subscription_list();h=h.get(0);h.scrollIntoView&&h.scrollIntoView();return h};this.replace_folder_row=function(a,b,d,e,g){if(!this.gui_objects.subscriptionlist)return false;var f,h,j,m,k=this.get_folder_row_id(a),
n=RegExp("^"+RegExp.escape(a));f=$('input[name="_subscribed[]"]',$("#"+k)).prop("checked");var o=this.get_subfolders(a);this._remove_folder_row(k);e=$(this.add_folder_row(b,d,e,f,true,g));if(d=o.length)m=a.split(this.env.delimiter).length-b.split(this.env.delimiter).length;for(a=0;a<d;a++){k=o[a];f=this.env.subscriptionrows[k][0];g=this.env.subscriptionrows[k][1];h=$("#"+k);j=h.clone(true);h.remove();e.after(j);e=j;f=f.replace(n,b);$('input[name="_subscribed[]"]',e).val(f);this.env.subscriptionrows[k][0]=
f;if(m!=0){if(m>0)for(f=m;f>0;f--)g=g.replace(/^&nbsp;&nbsp;&nbsp;&nbsp;/,"");else for(f=m;f<0;f++)g="&nbsp;&nbsp;&nbsp;&nbsp;"+g;e.find("td:first").html(g);this.env.subscriptionrows[k][1]=g}}this.init_subscription_list()};this.remove_folder_row=function(a,b){var d,e,g=[];d=this.get_folder_row_id(a);if(b)g=this.get_subfolders(a);this._remove_folder_row(d);d=0;for(e=g.length;d<e;d++)this._remove_folder_row(g[d])};this._remove_folder_row=function(a){this.subscription_list.remove_row(a.replace(/^rcmrow/,
""));$("#"+a).remove();delete this.env.subscriptionrows[a]};this.get_subfolders=function(a){for(var b=[],d=RegExp("^"+RegExp.escape(a)+RegExp.escape(this.env.delimiter)),e=$("#"+this.get_folder_row_id(a)).get(0);e=e.nextSibling;)if(e.id){a=this.env.subscriptionrows[e.id][0];if(d.test(a))b.push(e.id);else break}return b};this.subscribe=function(a){if(a){var b=this.display_message(this.get_label("foldersubscribing"),"loading");this.http_post("subscribe",{_mbox:a},b)}};this.unsubscribe=function(a){if(a){var b=
this.display_message(this.get_label("folderunsubscribing"),"loading");this.http_post("unsubscribe",{_mbox:a},b)}};this.get_folder_row_id=function(a){var b,d=this.env.subscriptionrows;for(b in d)if(d[b]&&d[b][0]==a)break;return b};this.show_folder=function(a,b,d){var e=window;a="&_action=edit-folder&_mbox="+urlencode(a);if(b)a+="&_path="+urlencode(b);if(b=this.get_frame_window(this.env.contentframe)){e=b;a+="&_framed=1"}String(e.location.href).indexOf(a)>=0&&!d?this.show_contentframe(true):this.location_href(this.env.comm_path+
a,e,true)};this.disable_subscription=function(a){(a=this.get_folder_row_id(a))&&$('input[name="_subscribed[]"]',$("#"+a)).prop("disabled",true)};this.folder_size=function(a){var b=this.set_busy(true,"loading");this.http_post("folder-size",{_mbox:a},b)};this.folder_size_update=function(a){$("#folder-size").replaceWith(a)};var u=function(a,b){var d=document.getElementById(b.id);if(d){var e=false;if(b.type=="image"){d=d.parentNode;e=true}d._command=a;d._id=b.id;if(b.sel){d.onmousedown=function(){return rcmail.button_sel(this._command,
this._id)};d.onmouseup=function(){return rcmail.button_out(this._command,this._id)};if(e)(new Image).src=b.sel}if(b.over){d.onmouseover=function(){return rcmail.button_over(this._command,this._id)};d.onmouseout=function(){return rcmail.button_out(this._command,this._id)};if(e)(new Image).src=b.over}}};this.init_buttons=function(){for(var a in this.buttons)if(typeof a==="string")for(var b=0;b<this.buttons[a].length;b++)u(a,this.buttons[a][b]);this.set_button(this.task,"sel")};this.set_button=function(a,
b){var d,e,g,f=this.buttons[a],h=f?f.length:0;for(d=0;d<h;d++){e=f[d];if(g=document.getElementById(e.id)){if(e.type=="image"&&!e.status){e.pas=g._original_src?g._original_src:g.src;if(g.runtimeStyle&&g.runtimeStyle.filter&&g.runtimeStyle.filter.match(/src=['"]([^'"]+)['"]/))e.pas=RegExp.$1}else if(!e.status)e.pas=String(g.className);if(e.type=="image"&&e[b]){e.status=b;g.src=e[b]}else if(e[b]!==undefined){e.status=b;g.className=e[b]}if(e.type=="input"){e.status=b;g.disabled=!b}}}};this.set_alttext=
function(a,b){var d,e,g,f,h=this.buttons[a],j=h?h.length:0;for(d=0;d<j;d++){e=h[d];g=document.getElementById(e.id);if(e.type=="image"&&g){g.setAttribute("alt",this.get_label(b));if((f=g.parentNode)&&f.tagName.toLowerCase()=="a")f.setAttribute("title",this.get_label(b))}else g&&g.setAttribute("title",this.get_label(b))}};this.button_over=function(a,b){var d,e,g,f=this.buttons[a],h=f?f.length:0;for(d=0;d<h;d++){e=f[d];if(e.id==b&&e.status=="act")if((g=document.getElementById(e.id))&&e.over)if(e.type==
"image")g.src=e.over;else g.className=e.over}};this.button_sel=function(a,b){var d,e,g,f=this.buttons[a],h=f?f.length:0;for(d=0;d<h;d++){e=f[d];if(e.id==b&&e.status=="act"){if((g=document.getElementById(e.id))&&e.sel)if(e.type=="image")g.src=e.sel;else g.className=e.sel;this.buttons_sel[b]=a}}};this.button_out=function(a,b){var d,e,g,f=this.buttons[a],h=f?f.length:0;for(d=0;d<h;d++){e=f[d];if(e.id==b&&e.status=="act")if((g=document.getElementById(e.id))&&e.act)if(e.type=="image")g.src=e.act;else g.className=
e.act}};this.set_pagetitle=function(a){if(a&&document.title)document.title=a};this.display_message=function(a,b,d){if(this.is_framed())return parent.rcmail.display_message(a,b,d);if(!this.gui_objects.message){if(b!="loading")this.pending_message=[a,b,d];return 1}b=b?b:"notice";var e=this,g=this.html_identifier(a),f=b+(new Date).getTime();d||(d=this.message_time*(b=="error"||b=="warning"?2:1));if(b=="loading"){g="loading";d=this.env.request_timeout*1E3;a||(a=this.get_label("loading"))}if(this.messages[g]){this.messages[g].obj&&
this.messages[g].obj.html(a);b=="loading"&&this.messages[g].labels.push({id:f,msg:a});this.messages[g].elements.push(f);setTimeout(function(){e.hide_message(f,b=="loading")},d);return f}var h=$("<div>").addClass(b).html(a).data("key",g);$(this.gui_objects.message).append(h).show();this.messages[g]={obj:h,elements:[f]};if(b=="loading")this.messages[g].labels=[{id:f,msg:a}];else h.click(function(){return e.hide_message(h)});this.triggerEvent("message",{message:a,type:b,timeout:d,object:h});d>0&&setTimeout(function(){e.hide_message(f,
b=="loading")},d);return f};this.hide_message=function(a,b){if(this.is_framed())return parent.rcmail.hide_message(a,b);if(this.gui_objects.message){var d,e,g,f,h=this.messages;if(typeof a==="object"){$(a)[b?"fadeOut":"hide"]();f=$(a).data("key");this.messages[f]&&delete this.messages[f]}else for(d in h)for(e in h[d].elements)if(h[d]&&h[d].elements[e]==a){h[d].elements.splice(e,1);if(h[d].elements.length){if(d=="loading")for(g in h[d].labels){if(h[d].labels[g].id==a)delete h[d].labels[g];else f=h[d].labels[g].msg;
h[d].obj.html(f)}}else{h[d].obj[b?"fadeOut":"hide"]();delete h[d]}}}};this.clear_messages=function(){if(this.is_framed())return parent.rcmail.clear_messages();var a,b,d=this.messages;for(a in d)for(b in d[a].elements)d[a].obj&&d[a].obj.hide();this.messages={}};this.show_popup_dialog=function(a,b){if(this.is_framed())parent.rcmail.show_popup_dialog(a,b);else{var d=$('<div class="popup">').html(a).dialog({title:b,modal:true,resizable:true,width:580,close:function(){$(this).remove()}}),e=$(window),g=
e.width();e=e.height();var f=d.width(),h=d.height();d.dialog("option",{height:Math.min(e-40,h+50),width:Math.min(g-20,f+50)}).dialog("option","position",["center","center"])}};this.set_page_buttons=function(){this.enable_command("nextpage","lastpage",this.env.pagecount>this.env.current_page);this.enable_command("previouspage","firstpage",this.env.current_page>1)};this.select_folder=function(a,b,d){if(this.gui_objects.folderlist){var e;if(e=$("li.selected",this.gui_objects.folderlist))e.removeClass("selected").addClass("unfocused");
if(d=this.get_folder_li(a,b,d))$(d).removeClass("unfocused").addClass("selected");this.triggerEvent("selectfolder",{folder:a,prefix:b})}};this.mark_folder=function(a,b,d,e){$(this.get_folder_li(a,d,e)).addClass(b)};this.unmark_folder=function(a,b,d,e){$(this.get_folder_li(a,d,e)).removeClass(b)};this.get_folder_li=function(a,b,d){b||(b="rcmli");if(this.gui_objects.folderlist){a=this.html_identifier(a,d);return document.getElementById(b+a)}return null};this.set_message_coltypes=function(a,b,d){var e=
this.message_list,g=e?e.list.tHead:null,f,h,j;this.env.coltypes=a;if(g){if(b){f=document.createElement("thead");j=document.createElement("tr");c=0;for(h=b.length;c<h;c++){a=document.createElement("td");a.innerHTML=b[c].html||"";if(b[c].id)a.id=b[c].id;if(b[c].className)a.className=b[c].className;j.appendChild(a)}f.appendChild(j);g.parentNode.replaceChild(f,g);e.thead=g=f}f=0;for(h=this.env.coltypes.length;f<h;f++){b=this.env.coltypes[f];if((a=g.rows[0].cells[f])&&(b=="from"||b=="to"||b=="fromto")){a.id=
"rcm"+b;$("span,a",a).text(this.get_label(b=="fromto"?d:b));$("a",a).click(function(){return rcmail.command("sort",this.id.replace(/^rcm/,""),this)})}}}this.env.subject_col=null;this.env.flagged_col=null;this.env.status_col=null;if((f=$.inArray("subject",this.env.coltypes))>=0){this.env.subject_col=f;if(e)e.subject_col=f}if((f=$.inArray("flag",this.env.coltypes))>=0)this.env.flagged_col=f;if((f=$.inArray("status",this.env.coltypes))>=0)this.env.status_col=f;e&&e.init_header()};this.set_rowcount=function(a,
b){if(b&&b!=this.env.mailbox)return false;$(this.gui_objects.countdisplay).html(a);this.set_page_buttons()};this.set_mailboxname=function(a){if(this.gui_objects.mailboxname&&a)this.gui_objects.mailboxname.innerHTML=a};this.set_quota=function(a){this.gui_objects.quotadisplay&&a&&a.type=="text"&&$(this.gui_objects.quotadisplay).html(a.percent+"%").attr("title",a.title);this.triggerEvent("setquota",a);this.env.quota_content=a};this.set_unread_count=function(a,b,d,e){if(!this.gui_objects.mailboxlist)return false;
this.env.unread_counts[a]=b;this.set_unread_count_display(a,d);if(e)this.mark_folder(a,e,"",true);else b||this.unmark_folder(a,"recent","",true)};this.set_unread_count_display=function(a,b){var d,e,g,f,h;if(g=this.get_folder_li(a,"",true)){f=this.env.unread_counts[a]?this.env.unread_counts[a]:0;e=$(g).children("a").eq(0);d=e.children("span.unreadcount");if(!d.length&&f)d=$("<span>").addClass("unreadcount").appendTo(e);e=0;if((h=g.getElementsByTagName("div")[0])&&h.className.match(/collapsed/))for(var j in this.env.unread_counts)if(j.indexOf(a+
this.env.delimiter)==0)e+=this.env.unread_counts[j];if(f&&d.length)d.html(this.env.unreadwrap.replace(/%[sd]/,f));else d.length&&d.remove();d=RegExp(RegExp.escape(this.env.delimiter)+"[^"+RegExp.escape(this.env.delimiter)+"]+$");a.match(d)&&this.set_unread_count_display(a.replace(d,""),false);f+e>0?$(g).addClass("unread"):$(g).removeClass("unread")}d=/^\([0-9]+\)\s+/i;if(b&&document.title){g="";g=String(document.title);g=f&&g.match(d)?g.replace(d,"("+f+") "):f?"("+f+") "+g:g.replace(d,"");this.set_pagetitle(g)}};
this.set_headers=function(a){this.gui_objects.all_headers_row&&this.gui_objects.all_headers_box&&a&&$(this.gui_objects.all_headers_box).html(a).show()};this.show_headers=function(a,b){if(!(!this.gui_objects.all_headers_row||!this.gui_objects.all_headers_box||!this.env.uid)){$(b).removeClass("show-headers").addClass("hide-headers");$(this.gui_objects.all_headers_row).show();b.onclick=function(){rcmail.command("hide-headers","",b)};this.gui_objects.all_headers_box.innerHTML||this.http_post("headers",
{_uid:this.env.uid},this.display_message(this.get_label("loading"),"loading"))}};this.hide_headers=function(a,b){if(this.gui_objects.all_headers_row&&this.gui_objects.all_headers_box){$(b).removeClass("hide-headers").addClass("show-headers");$(this.gui_objects.all_headers_row).hide();b.onclick=function(){rcmail.command("show-headers","",b)}}};this.html2plain=function(a,b){var d=this,e=this.set_busy(true,"converting");this.log("HTTP POST: ?_task=utils&_action=html2text");$.ajax({type:"POST",url:"?_task=utils&_action=html2text",
data:a,contentType:"application/octet-stream",error:function(g,f,h){d.http_error(g,f,h,e)},success:function(g){d.set_busy(false,null,e);$("#"+b).val(g);d.log(g)}})};this.plain2html=function(a,b){var d=this.set_busy(true,"converting");a=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");$("#"+b).val(a?"<pre>"+a+"</pre>":"");this.set_busy(false,null,d)};this.url=function(a,b){var d=typeof b==="string"?"&"+b:"";if(typeof a!=="string")b=a;else if(!b||typeof b!=="object")b={};b._action=
a?a:this.env.action;var e=this.env.comm_path,g,f={};if(b._action.match(/([a-z]+)\/([a-z0-9-_.]+)/)){b._action=RegExp.$2;e=e.replace(/\_task=[a-z]+/,"_task="+RegExp.$1)}for(g in b)if(b[g]!==undefined&&b[g]!==null)f[g]=b[g];return e+"&"+$.param(f)+d};this.redirect=function(a,b){if(b||b===null)this.set_busy(true);if(this.is_framed())parent.rcmail.redirect(a,b);else{if(this.env.extwin)if(typeof a=="string")a+=(a.indexOf("?")<0?"?":"&")+"_extwin=1";else a._extwin=1;this.location_href(a,window)}};this.goto_url=
function(a,b){this.redirect(this.url(a,b))};this.location_href=function(a,b,d){d&&this.lock_frame();if(typeof a=="object")a=this.env.comm_path+"&"+$.param(a);if(bw.ie&&b==window)$("<a>").attr("href",a).appendTo(document.body).get(0).click();else b.location.href=a;this.start_keepalive()};this.http_request=function(a,b,d){var e=this.url(a,b);b=this.triggerEvent("request"+a,b);if(b!==undefined)if(b===false)return false;else b=b;e+="&_remote=1";this.log("HTTP GET: "+e);this.start_keepalive();return $.ajax({type:"GET",
url:e,data:{_unlock:d?d:0},dataType:"json",success:function(g){l.http_response(g)},error:function(g,f,h){l.http_error(g,f,h,d,a)}})};this.http_post=function(a,b,d){var e=this.url(a);if(b&&typeof b==="object"){b._remote=1;b._unlock=d?d:0}else b+=(b?"&":"")+"_remote=1"+(d?"&_unlock="+d:"");var g=this.triggerEvent("request"+a,b);if(g!==undefined)if(g===false)return false;else b=g;this.log("HTTP POST: "+e);this.start_keepalive();return $.ajax({type:"POST",url:e,data:b,dataType:"json",success:function(f){l.http_response(f)},
error:function(f,h,j){l.http_error(f,h,j,d,a)}})};this.abort_request=function(a){a.request&&a.request.abort();a.lock&&this.set_busy(false,null,a.lock)};this.http_response=function(a){if(a){a.unlock&&this.set_busy(false);this.triggerEvent("responsebefore",{response:a});this.triggerEvent("responsebefore"+a.action,{response:a});a.env&&this.set_env(a.env);if(typeof a.texts==="object")for(var b in a.texts)typeof a.texts[b]==="string"&&this.add_label(b,a.texts[b]);if(a.exec){this.log(a.exec);eval(a.exec)}if(a.callbacks&&
a.callbacks.length)for(b=0;b<a.callbacks.length;b++)this.triggerEvent(a.callbacks[b][0],a.callbacks[b][1]);switch(a.action){case "delete":if(this.task=="addressbook"){var d;b=this.contact_list.get_selection();d=false;if(b&&this.contact_list.rows[b])if(this.env.source=="")d=(d=String(b).replace(/^[^-]+-/,""))&&this.env.address_sources[d]&&!this.env.address_sources[d].readonly;else d=!this.env.address_sources[this.env.source].readonly;this.enable_command("compose",b&&this.contact_list.rows[b]);this.enable_command("delete",
"edit",d);this.enable_command("export",this.contact_list&&this.contact_list.rowcount>0)}case "moveto":if(this.env.action=="show"){this.enable_command(this.env.message_commands,true);this.env.list_post||this.enable_command("reply-list",false)}else this.task=="addressbook"&&this.triggerEvent("listupdate",{folder:this.env.source,rowcount:this.contact_list.rowcount});case "purge":case "expunge":if(this.task=="mail"){if(!this.env.exists){this.env.contentframe&&this.show_contentframe(false);this.enable_command(this.env.message_commands,
"purge","expunge","select-all","select-none","expand-all","expand-unread","collapse-all",false)}this.message_list&&this.triggerEvent("listupdate",{folder:this.env.mailbox,rowcount:this.message_list.rowcount})}break;case "refresh":case "check-recent":case "getunread":case "search":this.env.qsearch=null;case "list":if(this.task=="mail"){this.enable_command("show","select-all","select-none",this.env.messagecount>0);this.enable_command("expunge",this.env.exists);this.enable_command("purge",this.purge_mailbox_test());
this.enable_command("expand-all","expand-unread","collapse-all",this.env.threading&&this.env.messagecount);if((a.action=="list"||a.action=="search")&&this.message_list){this.msglist_select(this.message_list);this.triggerEvent("listupdate",{folder:this.env.mailbox,rowcount:this.message_list.rowcount})}}else if(this.task=="addressbook"){this.enable_command("export",this.contact_list&&this.contact_list.rowcount>0);if(a.action=="list"||a.action=="search"){this.enable_command("search-create",this.env.source==
"");this.enable_command("search-delete",this.env.search_id);this.update_group_commands();this.triggerEvent("listupdate",{folder:this.env.source,rowcount:this.contact_list.rowcount})}}}a.unlock&&this.hide_message(a.unlock);this.triggerEvent("responseafter",{response:a});this.triggerEvent("responseafter"+a.action,{response:a});this.start_keepalive()}};this.http_error=function(a,b,d,e,g){d=a.statusText;this.set_busy(false,null,e);a.abort();if(!this.unload){if(a.status&&d)this.display_message(this.get_label("servererror")+
" ("+d+")","error");else if(b=="timeout")this.display_message(this.get_label("requesttimedout"),"error");else a.status==0&&b!="abort"&&this.display_message(this.get_label("servererror")+" (No connection)","error");(b=a.getResponseHeader("Location"))&&this.env.action!="compose"&&this.redirect(b);if(a.status==403)(this.is_framed()?parent:window).location.reload();else g=="keep-alive"&&setTimeout(function(){l.keep_alive();l.start_keepalive()},3E4)}};this.iframe_loaded=function(a){this.set_busy(false,
null,a);this.submit_timer&&clearTimeout(this.submit_timer)};this.async_upload_form=function(a,b,d){var e,g=(new Date).getTime(),f="rcmupload"+g;if(this.env.upload_progress_name){e=this.env.upload_progress_name;var h=$("input[name="+e+"]",a);if(!h.length){h=$("<input>").attr({type:"hidden",name:e});h.prependTo(a)}h.val(g)}if(document.all){document.body.insertAdjacentHTML("BeforeEnd",'<iframe name="'+f+'" src="program/resources/blank.gif" style="width:0;height:0;visibility:hidden;"></iframe>');e=$('iframe[name="'+
f+'"]')}else e=$("<iframe>").attr("name",f).css({border:"none",width:0,height:0,visibility:"hidden"}).appendTo(document.body);e.bind("load",{ts:g},d);$(a).attr({target:f,action:this.url(b,{_id:this.env.compose_id||"",_uploadid:g}),method:"POST"}).attr(a.encoding?"encoding":"enctype","multipart/form-data").submit();return f};this.document_drag_hover=function(a,b){a.preventDefault();$(l.gui_objects.filedrop)[b?"addClass":"removeClass"]("active")};this.file_drag_hover=function(a,b){a.preventDefault();
a.stopPropagation();$(l.gui_objects.filedrop)[b?"addClass":"removeClass"]("hover")};this.file_dropped=function(a){this.file_drag_hover(a,false);var b=a.target.files||a.dataTransfer.files,d=window.FormData?new FormData:null,e=(this.env.filedrop.fieldname||"_file")+(this.env.filedrop.single?"":"[]"),g="------multipartformboundary"+(new Date).getTime(),f="--"+g+"\r\n";if(b&&b.length)for(var h=function(){var o=b.length>1,p=(new Date).getTime();o="<span>"+(o?l.get_label("uploadingmany"):b[0].name)+"</span>";
if(!l.add2attachment_list(p,{name:"",html:o,classname:"uploading",complete:false}))l.file_upload_id=l.set_busy(true,"uploading");f+="--"+g+"--\r\n";$.ajax({type:"POST",dataType:"json",url:l.url(l.env.filedrop.action||"upload",{_id:l.env.compose_id||l.env.cid||"",_uploadid:p,_remote:1}),contentType:d?false:"multipart/form-data; boundary="+g,processData:false,timeout:0,data:d||f,headers:{"X-Roundcube-Request":l.env.request_token},xhr:function(){var q=jQuery.ajaxSettings.xhr();if(!d&&q.sendAsBinary)q.send=
q.sendAsBinary;return q},success:function(q){l.http_response(q)},error:function(q,s,t){l.http_error(q,s,t,null,"attachment")}})},j=this.env.filedrop.single?0:b.length-1,m=a=0,k;a<=j&&(k=b[m]);m++){if(!k.name)k.name=k.fileName;if(!k.size)k.size=k.fileSize;if(!k.type)k.type="application/octet-stream";if(!d&&/[^\x20-\x7E]/.test(k.name))k.name_bin=unescape(encodeURIComponent(k.name));if(!(this.env.filedrop.filter&&!k.type.match(RegExp(this.env.filedrop.filter)))){if(d){d.append(e,k);if(a==j)return h()}else if(window.FileReader){var n=
new FileReader;n.onload=function(o,p){return function(){f+='Content-Disposition: form-data; name="'+e+'"';f+='; filename="'+(k.name_bin||o.name)+'"\r\n';f+="Content-Length: "+o.size+"\r\n";f+="Content-Type: "+o.type+"\r\n\r\n";f+=n.result+"\r\n";f+="--"+g+"\r\n";if(p==j)return h()}}(k,a);n.readAsBinaryString(k)}else if(k.getAsBinary){f+='Content-Disposition: form-data; name="'+e+'"';f+='; filename="'+(k.name_bin||k.name)+'"\r\n';f+="Content-Length: "+k.size+"\r\n";f+="Content-Type: "+k.type+"\r\n\r\n";
f+=k.getAsBinary()+"\r\n";f+="--"+g+"\r\n";if(a==j)return h()}a++}}};this.start_keepalive=function(){if(!(!this.env.session_lifetime||this.env.framed||this.env.extwin||this.task=="login"||this.env.action=="print")){this._keepalive&&clearInterval(this._keepalive);this._keepalive=setInterval(function(){l.keep_alive()},this.env.session_lifetime*0.5*1E3)}};this.start_refresh=function(){if(!(!this.env.refresh_interval||this.env.framed||this.env.extwin||this.task=="login"||this.env.action=="print")){this._refresh&&
clearInterval(this._refresh);this._refresh=setInterval(function(){l.refresh()},this.env.refresh_interval*1E3)}};this.keep_alive=function(){this.busy||this.http_request("keep-alive")};this.refresh=function(){if(this.busy)setTimeout(function(){l.refresh();l.start_refresh()},1E4);else{var a={},b=this.set_busy(true,"refreshing");if(this.task=="mail"&&this.gui_objects.mailboxlist)a=this.check_recent_params();this.http_request("refresh",a,b)}};this.check_recent_params=function(){var a={_mbox:this.env.mailbox};
if(this.gui_objects.mailboxlist)a._folderlist=1;if(this.gui_objects.messagelist)a._list=1;if(this.gui_objects.quotadisplay)a._quota=1;if(this.env.search_request)a._search=this.env.search_request;return a};this.opener=function(){try{if(window.opener&&!opener.closed&&opener.rcmail)return opener.rcmail}catch(a){}};this.get_single_uid=function(){return this.env.uid?this.env.uid:this.message_list?this.message_list.get_single_selection():null};this.get_single_cid=function(){return this.env.cid?this.env.cid:
this.contact_list?this.contact_list.get_single_selection():null};this.get_caret_pos=function(a){if(a.selectionEnd!==undefined)return a.selectionEnd;if(document.selection&&document.selection.createRange){var b=document.selection.createRange();if(b.parentElement()!=a)return 0;var d=b.duplicate();a.tagName=="TEXTAREA"?d.moveToElementText(a):d.expand("textedit");d.setEndPoint("EndToStart",b);b=d.text.length;return b<=a.value.length?b:-1}return a.value.length};this.set_caret_pos=function(a,b){if(a.setSelectionRange)a.setSelectionRange(b,
b);else if(a.createTextRange){var d=a.createTextRange();d.collapse(true);d.moveEnd("character",b);d.moveStart("character",b);d.select()}};this.lock_form=function(a,b){if(a&&a.elements){var d,e,g;if(b)this.disabled_form_elements=[];d=0;for(e=a.elements.length;d<e;d++){g=a.elements[d];if(g.type!="hidden")if(b&&g.disabled)this.disabled_form_elements.push(g);else if(b||this.disabled_form_elements&&$.inArray(g,this.disabled_form_elements)<0)g.disabled=b}}};this.mailto_handler_uri=function(){return location.href.split("?")[0]+
"?_task=mail&_action=compose&_to=%s"};this.register_protocol_handler=function(a){try{window.navigator.registerProtocolHandler("mailto",this.mailto_handler_uri(),a)}catch(b){}};this.check_protocol_handler=function(a,b){var d=window.navigator;!d||typeof d.registerProtocolHandler!="function"||typeof d.isProtocolHandlerRegistered=="function"&&d.isProtocolHandlerRegistered("mailto",this.mailto_handler_uri())=="registered"?$(b).addClass("disabled"):$(b).click(function(){rcmail.register_protocol_handler(a);
return false})};this.browser_capabilities_check=function(){if(!this.env.browser_capabilities)this.env.browser_capabilities={};if(this.env.browser_capabilities.pdf===undefined)this.env.browser_capabilities.pdf=this.pdf_support_check();if(this.env.browser_capabilities.flash===undefined)this.env.browser_capabilities.flash=this.flash_support_check();this.env.browser_capabilities.tif===undefined&&this.tif_support_check()};this.browser_capabilities=function(){if(!this.env.browser_capabilities)return"";
var a,b=[];for(a in this.env.browser_capabilities)b.push(a+"="+this.env.browser_capabilities[a]);return b.join()};this.tif_support_check=function(){var a=new Image;a.onload=function(){rcmail.env.browser_capabilities.tif=1};a.onerror=function(){rcmail.env.browser_capabilities.tif=0};a.src="program/resources/blank.tif"};this.pdf_support_check=function(){var a=navigator.mimeTypes?navigator.mimeTypes["application/pdf"]:{},b=navigator.plugins,d=b.length,e=/Adobe Reader|PDF|Acrobat/i;if(a&&a.enabledPlugin)return 1;
if(window.ActiveXObject){try{if(axObj=new ActiveXObject("AcroPDF.PDF"))return 1}catch(g){}try{if(axObj=new ActiveXObject("PDF.PdfCtrl"))return 1}catch(f){}}for(i=0;i<d;i++){a=b[i];if(typeof a==="String"){if(e.test(a))return 1}else if(a.name&&e.test(a.name))return 1}return 0};this.flash_support_check=function(){var a=navigator.mimeTypes?navigator.mimeTypes["application/x-shockwave-flash"]:{};if(a&&a.enabledPlugin)return 1;if(window.ActiveXObject)try{if(axObj=new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))return 1}catch(b){}return 0};
this.set_cookie=function(a,b,d){setCookie(a,b,d,this.env.cookie_path,this.env.cookie_domain,this.env.cookie_secure)}}rcube_webmail.long_subject_title=function(l,u){if(!l.title){var a=$(l);if(a.width()+u*15>a.parent().width())l.title=a.text()}};
rcube_webmail.long_subject_title_ex=function(l,u){if(!l.title){var a=$(l),b=$.trim(a.text()),d=$("<span>").text(b).css({position:"absolute","float":"left",visibility:"hidden","font-size":a.css("font-size"),"font-weight":a.css("font-weight")}).appendTo($("body")),e=d.width();d.remove();if(e+u*15>a.width())l.title=b}};rcube_webmail.prototype.get_cookie=getCookie;rcube_webmail.prototype.addEventListener=rcube_event_engine.prototype.addEventListener;rcube_webmail.prototype.removeEventListener=rcube_event_engine.prototype.removeEventListener;
rcube_webmail.prototype.triggerEvent=rcube_event_engine.prototype.triggerEvent;
